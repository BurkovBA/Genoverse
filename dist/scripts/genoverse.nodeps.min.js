var Base=function(){};Base.extend=function(e,t){var i=Base.prototype.extend;Base._prototyping=!0;var s=new this;i.call(s,e),delete Base._prototyping;var r=s.constructor,a=s.constructor=function(){if(!Base._prototyping)if(this._constructing||this.constructor==a)this._constructing=!0,r.apply(this,arguments),delete this._constructing;else if(null!=arguments[0])return(arguments[0].extend||i).call(arguments[0],s)};return a.ancestor=this,a.extend=this.extend,a.forEach=this.forEach,a.implement=this.implement,a.prototype=s,a.toString=this.toString,a.valueOf=function(e){return"object"==e?a:r.valueOf()},i.call(a,t),"function"==typeof a.init&&a.init(),a},Base.prototype={extend:function(e,t){if(arguments.length>1){var i=this[e];if(i&&"function"==typeof t&&(!i.valueOf||i.valueOf()!=t.valueOf())&&/\bbase\b/.test(t)){var s=t.valueOf();(t=function(){var e=this.base||Base.prototype.base;this.base=i;var t=s.apply(this,arguments);return this.base=e,t}).valueOf=function(e){return"object"==e?t:s},t.toString=Base.toString}this[e]=t}else if(e){var r=Base.prototype.extend;Base._prototyping||"function"==typeof this||(r=this.extend||r);for(var a={toSource:null},o=["constructor","toString","valueOf"],n=Base._prototyping?0:1;h=o[n++];)e[h]!=a[h]&&r.call(this,h,e[h]);for(var h in e)a[h]||r.call(this,h,e[h])}return this},base:function(){}},Base=Base.extend({constructor:function(){this.extend(arguments[0])}},{ancestor:Object,version:"1.1",forEach:function(e,t,i){for(var s in e)void 0===this.prototype[s]&&t.call(i,e[s],s,e)},implement:function(){for(var e=0;e<arguments.length;e++)"function"==typeof arguments[e]?arguments[e](this.prototype):this.prototype.extend(arguments[e]);return this},toString:function(){return String(this.valueOf())}});var RTree=function(e){var t=3,i=6;isNaN(e)||(t=Math.floor(e/2),i=e);var s,r={x:0,y:0,w:0,h:0,id:"root",nodes:[]},a=function(e){return"[object Array]"===Object.prototype.toString.call(e)},o=(s={},function(e){var t=0;return e in s?t=s[e]++:s[e]=0,e+"_"+t});RTree.Rectangle.squarified_ratio=function(e,t,i){var s=(e+t)/2,r=e*t;return r*i/(r/(s*s))};var n=function(e,i,s){var r=[],a=[],o=[];if(!e||!RTree.Rectangle.overlap_rectangle(e,s))return o;var n={x:e.x,y:e.y,w:e.w,h:e.h,target:i};a.push(s.nodes.length),r.push(s);do{var h=r.pop(),l=a.pop()-1;if("target"in n)for(;l>=0;){var c=h.nodes[l];if(RTree.Rectangle.overlap_rectangle(n,c)){if(n.target&&"leaf"in c&&c.leaf===n.target||!n.target&&("leaf"in c||RTree.Rectangle.contains_rectangle(c,n))){"nodes"in c?(o=d(c,!0,[],c),h.nodes.splice(l,1)):o=h.nodes.splice(l,1),RTree.Rectangle.make_MBR(h.nodes,h),delete n.target,h.nodes.length<t&&(n.nodes=d(h,!0,[],h));break}"nodes"in c&&(1,a.push(l),r.push(h),h=c,l=c.nodes.length)}l-=1}else if("nodes"in n){h.nodes.splice(l+1,1),h.nodes.length>0&&RTree.Rectangle.make_MBR(h.nodes,h);for(var u=0;u<n.nodes.length;u++)g(n.nodes[u],h);n.nodes.length=0,0==r.length&&h.nodes.length<=1?(n.nodes=d(h,!0,n.nodes,h),h.nodes.length=0,r.push(h),a.push(1)):r.length>0&&h.nodes.length<t?(n.nodes=d(h,!0,n.nodes,h),h.nodes.length=0):delete n.nodes}else RTree.Rectangle.make_MBR(h.nodes,h);1}while(r.length>0);return o},h=function(e){for(var t=c(e);e.length>0;)l(e,t[0],t[1]);return t},l=function(e,i,s){for(var r,a,o,n=RTree.Rectangle.squarified_ratio(i.w,i.h,i.nodes.length+1),h=RTree.Rectangle.squarified_ratio(s.w,s.h,s.nodes.length+1),l=e.length-1;l>=0;l--){var c=e[l],d={};d.x=Math.min(i.x,c.x),d.y=Math.min(i.y,c.y),d.w=Math.max(i.x+i.w,c.x+c.w)-d.x,d.h=Math.max(i.y+i.h,c.y+c.h)-d.y;var g=Math.abs(RTree.Rectangle.squarified_ratio(d.w,d.h,i.nodes.length+2)-n),u={};u.x=Math.min(s.x,c.x),u.y=Math.min(s.y,c.y),u.w=Math.max(s.x+s.w,c.x+c.w)-u.x,u.h=Math.max(s.y+s.h,c.y+c.h)-u.y;var p=Math.abs(RTree.Rectangle.squarified_ratio(u.w,u.h,s.nodes.length+2)-h);(!a||!r||Math.abs(p-g)<r)&&(a=l,r=Math.abs(p-g),o=p<g?s:i)}var f=e.splice(a,1)[0];i.nodes.length+e.length+1<=t?(i.nodes.push(f),RTree.Rectangle.expand_rectangle(i,f)):s.nodes.length+e.length+1<=t?(s.nodes.push(f),RTree.Rectangle.expand_rectangle(s,f)):(o.nodes.push(f),RTree.Rectangle.expand_rectangle(o,f))},c=function(e){for(var t,i,s=e.length-1,r=0,a=e.length-1,o=0,n=e.length-2;n>=0;n--){var h=e[n];h.x>e[r].x?r=n:h.x+h.w<e[s].x+e[s].w&&(s=n),h.y>e[o].y?o=n:h.y+h.h<e[a].y+e[a].h&&(a=n)}return Math.abs(e[s].x+e[s].w-e[r].x)>Math.abs(e[a].y+e[a].h-e[o].y)?s>r?(t=e.splice(s,1)[0],i=e.splice(r,1)[0]):(i=e.splice(r,1)[0],t=e.splice(s,1)[0]):a>o?(t=e.splice(a,1)[0],i=e.splice(o,1)[0]):(i=e.splice(o,1)[0],t=e.splice(a,1)[0]),[{x:t.x,y:t.y,w:t.w,h:t.h,nodes:[t]},{x:i.x,y:i.y,w:i.w,h:i.h,nodes:[i]}]},d=function(e,t,i,s){var r=[];if(!RTree.Rectangle.overlap_rectangle(e,s))return i;r.push(s.nodes);do{for(var a=r.pop(),o=a.length-1;o>=0;o--){var n=a[o];RTree.Rectangle.overlap_rectangle(e,n)&&("nodes"in n?r.push(n.nodes):"leaf"in n&&(t?i.push(n):i.push(n.leaf)))}}while(r.length>0);return i},g=function(e,t){var s;if(0==t.nodes.length)return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,void t.nodes.push(e);var r=function(e,t){var i,s=-1,r=[];r.push(t);var a=t.nodes;do{-1!=s&&(r.push(a[s]),a=a[s].nodes,s=-1);for(var o=a.length-1;o>=0;o--){var n=a[o];if("leaf"in n){s=-1;break}var h=RTree.Rectangle.squarified_ratio(n.w,n.h,n.nodes.length+1),l=Math.max(n.x+n.w,e.x+e.w)-Math.min(n.x,e.x),c=Math.max(n.y+n.h,e.y+e.h)-Math.min(n.y,e.y),d=RTree.Rectangle.squarified_ratio(l,c,n.nodes.length+2);(s<0||Math.abs(d-h)<i)&&(i=Math.abs(d-h),s=o)}}while(-1!=s);return r}(e,t),o=e;do{if(s&&"nodes"in s&&0==s.nodes.length){var n=s;s=r.pop();for(var l=0;l<s.nodes.length;l++)if(s.nodes[l]===n||0==s.nodes[l].nodes.length){s.nodes.splice(l,1);break}}else s=r.pop();if("leaf"in o||"nodes"in o||a(o)){if(a(o)){for(var c=0;c<o.length;c++)RTree.Rectangle.expand_rectangle(s,o[c]);s.nodes=s.nodes.concat(o)}else RTree.Rectangle.expand_rectangle(s,o),s.nodes.push(o);if(s.nodes.length<=i)o={x:s.x,y:s.y,w:s.w,h:s.h};else{var d=h(s.nodes);o=d,r.length<1&&(s.nodes.push(d[0]),r.push(s),o=d[1])}}else RTree.Rectangle.expand_rectangle(s,o),o={x:s.x,y:s.y,w:s.w,h:s.h}}while(r.length>0)};this.get_tree=function(){return r},this.set_tree=function(e,t){return t||(t=r),s=e,(i=t).nodes=s.nodes,i.x=s.x,i.y=s.y,i.w=s.w,i.h=s.h,i;var i,s},this.search=function(e,t,i){if(arguments.length<1)throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle.";switch(arguments.length){case 1:arguments[1]=!1;case 2:arguments[2]=[];case 3:arguments[3]=r;default:arguments.length=4}return d.apply(this,arguments)},this.toJSON=function(e,t){var i=[],s=[],a={},n=3,h=1,l="";if(e&&!RTree.Rectangle.overlap_rectangle(e,r))return"";t?(n+=4,s.push(t.nodes.length),i.push(t.nodes),l+="var main_tree = {x:"+t.x.toFixed()+",y:"+t.y.toFixed()+",w:"+t.w.toFixed()+",h:"+t.h.toFixed()+",nodes:["):(s.push(r.nodes.length),i.push(r.nodes),l+="var main_tree = {x:"+r.x.toFixed()+",y:"+r.y.toFixed()+",w:"+r.w.toFixed()+",h:"+r.h.toFixed()+",nodes:[");do{var c=i.pop(),d=s.pop()-1;for(d>=0&&d<c.length-1&&(l+=",");d>=0;){var g=c[d];if(!e||RTree.Rectangle.overlap_rectangle(e,g))if(g.nodes)if(h>=n){a.length;var u=o("saved_subtree");l+="{x:"+g.x.toFixed()+",y:"+g.y.toFixed()+",w:"+g.w.toFixed()+",h:"+g.h.toFixed()+",load:'"+u+".js'}",a[u]=this.toJSON(e,g),d>0&&(l+=",")}else l+="{x:"+g.x.toFixed()+",y:"+g.y.toFixed()+",w:"+g.w.toFixed()+",h:"+g.h.toFixed()+",nodes:[",h+=1,s.push(d),i.push(c),c=g.nodes,d=g.nodes.length;else if(g.leaf){var p=g.leaf.toJSON?g.leaf.toJSON():JSON.stringify(g.leaf);l+="{x:"+g.x.toFixed()+",y:"+g.y.toFixed()+",w:"+g.w.toFixed()+",h:"+g.h.toFixed()+",leaf:"+p+"}",d>0&&(l+=",")}else g.load&&(l+="{x:"+g.x.toFixed()+",y:"+g.y.toFixed()+",w:"+g.w.toFixed()+",h:"+g.h.toFixed()+",load:'"+g.load+"'}",d>0&&(l+=","));d-=1}d<0&&(l+="]}",h-=1)}while(i.length>0);for(var f in l+=";",a)l+="\nvar "+f+" = function(){"+a[f]+" return(main_tree);};";return l},this.remove=function(e,t){if(arguments.length<1)throw"Wrong number of arguments. RT.remove requires at least a bounding rectangle.";switch(arguments.length){case 1:arguments[1]=!1;case 2:arguments[2]=r;default:arguments.length=3}if(!1===arguments[1]){var i=0,s=[];do{i=s.length,s=s.concat(n.apply(this,arguments))}while(i!=s.length);return s}return n.apply(this,arguments)},this.insert=function(e,t){if(arguments.length<2)throw"Wrong number of arguments. RT.Insert requires at least a bounding rectangle and an object.";return g({x:e.x,y:e.y,w:e.w,h:e.h,leaf:t},r)}};RTree.Rectangle=function(e,t,i,s){var r,a,o,n,h,l;e.x?(r=e.x,o=e.y,0!==e.w&&!e.w&&e.x2?(h=e.x2-e.x,l=e.y2-e.y):(h=e.w,l=e.h),a=r+h,n=o+l):(a=(r=e)+(h=i),n=(o=t)+(l=s)),this.x1=this.x=function(){return r},this.y1=this.y=function(){return o},this.x2=function(){return a},this.y2=function(){return n},this.w=function(){return h},this.h=function(){return l},this.toJSON=function(){return'{"x":'+r.toString()+', "y":'+o.toString()+', "w":'+h.toString()+', "h":'+l.toString()+"}"},this.overlap=function(e){return this.x()<e.x2()&&this.x2()>e.x()&&this.y()<e.y2()&&this.y2()>e.y()},this.expand=function(e){var t=Math.min(this.x(),e.x()),i=Math.min(this.y(),e.y());return h=Math.max(this.x2(),e.x2())-t,l=Math.max(this.y2(),e.y2())-i,r=t,o=i,this},this.setRect=function(e,t,i,s){var r,a,o,n;e.x?(r=e.x,a=e.y,0!==e.w&&!e.w&&e.x2?(o=e.x2-e.x,n=e.y2-e.y):(o=e.w,n=e.h),r+o):((r=e)+(o=i),a=t,n=s)}},RTree.Rectangle.overlap_rectangle=function(e,t){return e.x<t.x+t.w&&e.x+e.w>t.x&&e.y<t.y+t.h&&e.y+e.h>t.y},RTree.Rectangle.contains_rectangle=function(e,t){return e.x+e.w<=t.x+t.w&&e.x>=t.x&&e.y+e.h<=t.y+t.h&&e.y>=t.y},RTree.Rectangle.expand_rectangle=function(e,t){var i=Math.min(e.x,t.x),s=Math.min(e.y,t.y);return e.w=Math.max(e.x+e.w,t.x+t.w)-i,e.h=Math.max(e.y+e.h,t.y+t.h)-s,e.x=i,e.y=s,e},RTree.Rectangle.make_MBR=function(e,t){if(e.length<1)return{x:0,y:0,w:0,h:0};t?t.x=e[0].x:t={x:e[0].x,y:e[0].y,w:e[0].w,h:e[0].h},t.y=e[0].y,t.w=e[0].w,t.h=e[0].h;for(var i=e.length-1;i>0;i--)RTree.Rectangle.expand_rectangle(t,e[i]);return t};var $=jQuery,Genoverse=Base.extend({urlParamTemplate:"r=__CHR__:__START__-__END__",width:1e3,longestLabel:30,defaultLength:5e3,defaultScrollDelta:100,tracks:[],plugins:[],dragAction:"scroll",wheelAction:"off",isStatic:!1,saveable:!1,saveKey:"",storageType:"sessionStorage",autoHideMessages:!0,trackAutoHeight:!1,hideEmptyTracks:!0,genome:void 0,useHash:void 0,chr:1,start:1,end:1e6,constructor:function(e){var t=this;if(!this.supported())return this.die("Your browser does not support this functionality");e.container=$(e.container),e.container&&e.container.length||(e.container=$("<div>").appendTo("body")),e.container.addClass("genoverse").data("genoverse",this),$.extend(this,e),this.eventNamespace=".genoverse."+ ++Genoverse.id,this.events={browser:{},tracks:{}},$.when(this.loadGenome(),this.loadPlugins()).always(function(){Genoverse.wrapFunctions(t),t.init()})},loadGenome:function(){if("string"==typeof this.genome){var genomeName=this.genome;return $.ajax({url:this.origin+"js/genomes/"+genomeName+".js",dataType:"script",context:this,success:function(){try{this.genome=eval(genomeName)}catch(e){console.log(e),this.die("Unable to load genome "+genomeName)}}})}},loadPlugins:function(e){var t=this,i=$.Deferred();e=e||this.plugins;function s(e){if("function"!=typeof Genoverse.Plugins[e]||!0===t.loadedPlugins[e])return[];var i=Genoverse.Plugins[e].requires,s=$.Deferred();function r(){!0!==t.loadedPlugins[e]&&(Genoverse.Plugins[e].call(t),t.container.addClass("gv-"+e.replace(/([A-Z])/g,"-$1").toLowerCase()+"-plugin"),t.loadedPlugins[e]=!0),s.resolve()}return i?$.when(t.loadPlugins(i)).done(r):r(),s}return this.loadedPlugins=this.loadedPlugins||{},"string"==typeof e&&(e=[e]),$.when.apply($,$.map(e,function(e){var i=t.origin+"css/"+e+".css",s=t.origin+"js/plugins/"+e+".js",r=$.Deferred();function a(){function s(){t.loadedPlugins[e]=t.loadedPlugins[e]||"script",r.resolve(e)}if(Genoverse.Plugins[e].noCSS||$('link[href="'+i+'"]').length)return s();$('<link href="'+i+'" rel="stylesheet">').on("load",s).appendTo("body")}return t.loadedPlugins[e]||$('script[src="'+s+'"]').length?a():$.getScript(s,a),r})).done(function(){for(var e,r=[],a=0;a<arguments.length;a++)e=arguments[a],!0!==t.loadedPlugins[e]&&r.push(s(e));$.when.apply($,r).always(i.resolve)}),i},init:function(){var e=this.width;this.addDomElements(e),this.addUserEventHandlers(),this.isStatic&&(this.dragAction=this.wheelAction="off",this.urlParamTemplate=!1),this.tracksById={},this.prev={},this.saveKey=this.saveKey?"genoverse-"+this.saveKey:"genoverse",this.urlParamTemplate=this.urlParamTemplate||"",this.useHash="boolean"==typeof this.useHash?this.useHash:"function"!=typeof window.history.pushState,this.textWidth=document.createElement("canvas").getContext("2d").measureText("W").width,this.labelWidth=this.labelContainer.outerWidth(!0),this.width-=this.labelWidth,this.paramRegex=this.urlParamTemplate?new RegExp("([?&;])"+this.urlParamTemplate.replace(/(\b(\w+=)?__CHR__(.)?)/,"$2([\\w\\.]+)$3").replace(/(\b(\w+=)?__START__(.)?)/,"$2(\\d+)$3").replace(/(\b(\w+=)?__END__(.)?)/,"$2(\\d+)$3")+"([;&])"):"";var t=this.getURLCoords(),i=t.chr&&t.start&&t.end?t:{chr:this.chr,start:this.start,end:this.end};this.chr=i.chr,this.genome&&!this.chromosomeSize&&(this.chromosomeSize=this.genome[this.chr].size),this.saveable?this.loadConfig():this.addTracks(),this.setRange(i.start,i.end)},loadConfig:function(){this.defaultTracks=$.extend([],!0,this.tracks);var e=window[this.storageType].getItem(this.saveKey);if(!e)return this.addTracks();e=JSON.parse(e);var t,i,s,r=this.tracksLibrary||[],a=[],o={},n={},h={};function l(e,t){for(i in t)"config"===i?h[t.id]=t[i]:e.prototype[i]=t[i]}for(t=0;t<this.tracks.length;t++)this.tracks[t].prototype.id&&(o[this.tracks[t].prototype.id]=this.tracks[t]);for(t=0;t<r.length;t++)r[t].prototype.name&&(n[r[t].prototype.name]=r[t]);for(t=0;t<e.length;t++)(s=o[e[t].id])?(l(s,e[t]),s._fromStorage=!0):n[e[t].name]&&(s=n[e[t].name],this.trackIds=this.trackIds||{},this.trackIds[s.prototype.id]=this.trackIds[s.prototype.id]||1,l(s=s.extend({id:s.prototype.id+(o[s.prototype.id]?this.trackIds[s.prototype.id]++:"")}),e[t]),a.push(s));for(t=0;t<this.tracks.length;t++)this.tracks[t].prototype.id&&!this.tracks[t]._fromStorage||a.push(this.tracks[t]);this.tracks=a,this.savedConfig=h,this.addTracks()},saveConfig:function(){if(!this._constructing&&this.saveable){for(var e=[],t=0;t<this.tracks.length;t++)this.tracks[t].id&&e.push({id:this.tracks[t].id,name:this.tracks[t].name,order:this.tracks[t].order,height:this.tracks[t].height,autoHeight:this.tracks[t].autoHeight,config:this.tracks[t].config});window[this.storageType].setItem(this.saveKey,JSON.stringify(e))}},resetConfig:function(){window[this.storageType].removeItem(this.saveKey),this._constructing=!0,this.savedConfig={},this.removeTracks($.extend([],this.tracks)),this.addTracks($.extend([],!0,this.defaultTracks)),this._constructing=!1},addDomElements:function(e){this.menus=$(),this.labelContainer=$('<ul class="gv-label-container">').appendTo(this.container).sortable({items:"li:not(.gv-unsortable)",handle:".gv-handle",axis:"y",helper:"clone",cursor:"move",update:$.proxy(this.updateTrackOrder,this),start:function(e,t){t.placeholder.css({height:t.item.height(),visibility:"visible"}).html(t.item.html()),t.helper.hide()}}),this.wrapper=$('<div class="gv-wrapper">').appendTo(this.container),this.selector=$('<div class="gv-selector gv-crosshair">').appendTo(this.wrapper),this.selectorControls=this.zoomInHighlight=this.zoomOutHighlight=$(),this.container.addClass("gv-canvas-container").width(e),this.isStatic||(this.selectorControls=$('<div class="gv-selector-controls">  <button class="gv-zoom-here">Zoom here</button>  <button class="gv-center">Center</button>  <button class="gv-cancel">Cancel</button></div>').appendTo(this.selector),this.zoomInHighlight=$('<div class="gv-canvas-zoom gv-i">  <div class="gv-t gv-l gv-h"></div>  <div class="gv-t gv-r gv-h"></div>  <div class="gv-t gv-l gv-v"></div>  <div class="gv-t gv-r gv-v"></div>  <div class="gv-b gv-l gv-h"></div>  <div class="gv-b gv-r gv-h"></div>  <div class="gv-b gv-l gv-v"></div>  <div class="gv-b gv-r gv-v"></div></div>').appendTo("body"),this.zoomOutHighlight=this.zoomInHighlight.clone().toggleClass("gv-i gv-o").appendTo("body"))},addUserEventHandlers:function(){var e=this,t={};this.container.on({mousedown:function(t){return e.hideMessages(),t.which&&1!==t.which||this===e.selector[0]&&t.target!==this||e.mousedown(t),!1},mousewheel:function(t,i,s,r){if(e.noWheelZoom)return!0;if(e.hideMessages(),0===r&&0!==s)e.startDragScroll(t),e.move(10*-s),e.stopDragScroll(!1);else if("zoom"===e.wheelAction)return e.mousewheelZoom(t,i)},dblclick:function(t){if(e.isStatic)return!0;e.hideMessages(),e.mousewheelZoom(t,1)}},".gv-image-container, .gv-selector"),this.selectorControls.on("click",function(t){var i=e.getSelectorPosition();switch(t.target.className){case"gv-zoom-here":e.setRange(i.start,i.end,!0);break;case"gv-center":e.moveTo(i.start,i.end,!0,!0);case"gv-cancel":e.cancelSelect()}}),t["mouseup"+this.eventNamespace]=$.proxy(this.mouseup,this),t["mousemove"+this.eventNamespace]=$.proxy(this.mousemove,this),t["keydown"+this.eventNamespace]=$.proxy(this.keydown,this),t["keyup"+this.eventNamespace]=$.proxy(this.keyup,this),t["mousewheel"+this.eventNamespace]=function(t){"zoom"===e.wheelAction&&(e.wheelTimeout&&clearTimeout(e.wheelTimeout),e.noWheelZoom=e.noWheelZoom||t.target!==e.container[0],e.wheelTimeout=setTimeout(function(){e.noWheelZoom=!1},300))},$(document).on(t),$(window).on((this.useHash?"hashchange":"popstate")+this.eventNamespace,$.proxy(this.popState,this))},onTracks:function(){for(var e,t=$.extend([],arguments),i=t.shift(),s=0;s<this.tracks.length;s++)this.tracks[s].disabled||((e=this.tracks[s]._interface[i])?this.tracks[s][e][i].apply(this.tracks[s][e],t):this.tracks[s][i]&&this.tracks[s][i].apply(this.tracks[s],t))},reset:function(){this.onTracks("reset"),this.scale=9e99,this.setRange(this.start,this.end)},setWidth:function(e){this.width=e,this.width-=this.labelWidth,this.container.width(e),this.onTracks("setWidth",this.width),this.reset()},mousewheelZoom:function(e,t){var i=this;return clearTimeout(this.zoomDeltaTimeout),clearTimeout(this.zoomTimeout),this.zoomDeltaTimeout=setTimeout(function(){t>0?i.zoomInHighlight.css({left:e.pageX-20,top:e.pageY-20,display:"block"}).animate({width:80,height:80,top:"-=20",left:"-=20"},{complete:function(){$(this).css({width:40,height:40,display:"none"})}}):i.zoomOutHighlight.css({left:e.pageX-40,top:e.pageY-40,display:"block"}).animate({width:40,height:40,top:"+=20",left:"+=20"},{complete:function(){$(this).css({width:80,height:80,display:"none"})}})},100),this.zoomTimeout=setTimeout(function(){i[t>0?"zoomIn":"zoomOut"](e.pageX-i.container.offset().left-i.labelWidth),"select"===i.dragAction&&i.moveSelector(e)},300),!1},startDragScroll:function(e){this.dragging="scroll",this.scrolling=!e,this.dragOffset=e?e.pageX-this.left:0,this.dragStart=this.start,this.scrollDelta=Math.max(this.scale,this.defaultScrollDelta)},stopDragScroll:function(e){this.dragging=!1,this.scrolling=!1,!1!==e&&(this.start!==this.dragStart&&this.updateURL(),this.checkTrackHeights())},startDragSelect:function(e){if(!e)return!1;var t=Math.max(0,e.pageX-this.wrapper.offset().left-2);this.dragging="select",this.selectorStalled=!1,this.selectorStart=t,this.selector.css({left:t,width:0}).removeClass("gv-crosshair"),this.selectorControls.hide()},stopDragSelect:function(e){if(!e)return!1;if(this.dragging=!1,this.selectorStalled=!0,this.selector.outerWidth(!0)<2)return this.cancelSelect();var t=Math.min(e.pageY-this.wrapper.offset().top,this.wrapper.outerHeight(!0)-1.2*this.selectorControls.outerHeight(!0)),i=this.getSelectorPosition();this.selectorControls.find(".gv-selector-location").html(this.chr+":"+i.start+"-"+i.end).end().css({top:t,left:this.selector.outerWidth(!0)/2-this.selectorControls.outerWidth(!0)/2}).show()},cancelSelect:function(e){e||(this.dragging=!1),this.selectorStalled=!1,this.selector.addClass("gv-crosshair").width(0),this.selectorControls.hide(),"scroll"===this.dragAction&&this.selector.hide()},dragSelect:function(e){var t=e.pageX-this.wrapper.offset().left;t>this.selectorStart?this.selector.css({left:this.selectorStart,width:Math.min(t-this.selectorStart,this.width-this.selectorStart-1)}):this.selector.css({left:Math.max(t,1),width:Math.min(this.selectorStart-t,this.selectorStart-1)})},setDragAction:function(e,t){this.dragAction=e,"select"===this.dragAction?this.selector.addClass("gv-crosshair").width(0).show():t&&!this.selector.hasClass("gv-crosshair")?this.selectorStalled=!1:(this.cancelSelect(),this.selector.hide())},toggleSelect:function(e){e?(this.prev.dragAction="scroll",this.setDragAction("select")):(this.setDragAction(this.prev.dragAction,!0),delete this.prev.dragAction)},setWheelAction:function(e){this.wheelAction=e},keydown:function(e){16!==e.which||this.prev.dragAction||"scroll"!==this.dragAction?27===e.which&&(this.cancelSelect(),this.closeMenus()):this.toggleSelect(!0)},keyup:function(e){16===e.which&&this.prev.dragAction&&this.toggleSelect()},mousedown:function(e){switch(e.shiftKey?"scroll"===this.dragAction&&this.toggleSelect(!0):this.prev.dragAction&&this.toggleSelect(),this.dragAction){case"select":this.startDragSelect(e);break;case"scroll":this.startDragScroll(e)}},mouseup:function(e,t){if(!this.dragging)return!1;switch(this.dragging){case"select":this.stopDragSelect(e);break;case"scroll":this.stopDragScroll(t)}},mousemove:function(e){if(this.dragging&&!this.scrolling)switch(this.dragAction){case"scroll":this.move(e.pageX-this.dragOffset-this.left);break;case"select":this.dragSelect(e)}else"select"===this.dragAction&&this.moveSelector(e)},moveSelector:function(e){this.selectorStalled||this.selector.css("left",e.pageX-this.wrapper.offset().left-2)},move:function(e){var t,i,s,r=this.scale;r>1&&(e=Math.round(e/r)*r),(s=this.left+e)<=this.minLeft?(s=this.minLeft,e=this.minLeft-this.left):s>=this.maxLeft&&(s=this.maxLeft,e=this.maxLeft-this.left),(i=(t=Math.max(Math.round(this.start-e/r),1))+this.length-1)>this.chromosomeSize&&(t=(i=this.chromosomeSize)-this.length+1),this.left=s,t!==this.dragStart&&(this.closeMenus(),this.cancelSelect(!0)),this.onTracks("move",e),this.setRange(t,i)},moveTo:function(e,t,i,s){this.setRange(e,t,i,s),this.prev.scale===this.scale&&(this.left=Math.max(Math.min(this.left+Math.round((this.prev.start-this.start)*this.scale),this.maxLeft),this.minLeft),this.onTracks("moveTo",this.start,this.end,(this.prev.start-this.start)*this.scale))},setRange:function(e,t,i,s){if(this.prev.start=this.start,this.prev.end=this.end,this.start=Math.max("number"==typeof e?Math.floor(e):parseInt(e,10),1),this.end=Math.min("number"==typeof t?Math.floor(t):parseInt(t,10),this.chromosomeSize),this.end<this.start&&(this.end=Math.min(this.start+this.defaultLength-1,this.chromosomeSize)),s&&this.end-this.start+1!==this.length)if(this.end===this.chromosomeSize)this.start=this.end-this.length+1;else{var r=(this.start+this.end)/2;this.start=Math.max(Math.floor(r-this.length/2),1),this.end=this.start+this.length-1,this.end>this.chromosomeSize&&(this.end=this.chromosomeSize,this.start=this.end-this.length+1)}else this.length=this.end-this.start+1;this.setScale(),!0!==i||this.prev.start===this.start&&this.prev.end===this.end||this.updateURL()},setScale:function(){this.prev.scale=this.scale,this.scale=this.width/this.length,this.scaledStart=this.start*this.scale,this.prev.scale!==this.scale&&(this.left=0,this.minLeft=Math.round((this.end-this.chromosomeSize)*this.scale),this.maxLeft=Math.round((this.start-1)*this.scale),this.labelBuffer=Math.ceil(this.textWidth/this.scale)*this.longestLabel,this.prev.scale&&(this.cancelSelect(),this.closeMenus()),this.onTracks("setScale"),this.onTracks("makeFirstImage"))},checkTrackHeights:function(){this.dragging||this.onTracks("checkHeight")},resetTrackHeights:function(){this.onTracks("resetHeight")},zoomIn:function(e){e||(e=this.width/2);var t=Math.round(this.start+e/(2*this.scale)),i=2===this.length?t:Math.round(t+(this.length-1)/2);this.setRange(t,i,!0)},zoomOut:function(e){e||(e=this.width/2);var t=Math.round(this.start-e/this.scale),i=1===this.length?t+1:Math.round(t+2*(this.length-1));this.setRange(t,i,!0)},addTrack:function(e,t){return this.addTracks([e],t)[0]},addTracks:function(e,t){var i={browser:this,width:this.width},s=!!e;e=e||$.extend([],this.tracks),t=t||0;for(var r=0;r<e.length;r++)e[r]=new e[r]($.extend(i,{index:r+t,config:this.savedConfig?$.extend(!0,{},this.savedConfig[e[r].prototype.id]):void 0})),e[r].id&&(this.tracksById[e[r].id]=e[r]),s?(this.tracks.push(e[r]),this.scale&&(e[r].controller.setScale(),e[r].controller.makeFirstImage())):this.tracks[r]=e[r];return this.sortTracks(),this.saveConfig(),e},removeTrack:function(e){this.removeTracks([e])},removeTracks:function(e){for(var t,i,s=e.length;s--;){for(t=e[s],i=this.tracks.length;i--;)if(t===this.tracks[i]){this.tracks.splice(i,1);break}t.id&&delete this.tracksById[t.id],t.destructor()}this.saveConfig()},sortTracks:function(){if(!$.grep(this.tracks,function(e){return"object"!=typeof e}).length){for(var e=$.extend([],this.tracks).sort(function(e,t){return e.order-t.order}),t=$(),i=$(),s=0;s<e.length;s++)e[s].prop("unsortable")||e[s].prop("order",s),e[s].prop("menus").length&&e[s].prop("top",e[s].prop("container").position().top),t.push(e[s].prop("label")[0]),i.push(e[s].prop("container")[0]);this.labelContainer.append(t),this.wrapper.append(i),this.tracks=e,t.map(function(){return $(this).data("track")}).each(function(){if(this.prop("menus").length){var e=this.prop("container").position().top-this.prop("top");this.prop("menus").css("top",function(t,i){return parseInt(i,10)+e}),this.prop("top",null)}}),e=t=i=null}},updateTrackOrder:function(e,t){var i,s=t.item.data("track"),r=t.item.prev().data("track"),a=t.item.next().data("track"),o=r?r.prop("order"):0,n=a?a.prop("order"):0,h=o||n;i=r&&a&&Math.floor(n)===Math.floor(o)?o+(n-o)/2:h+(o?1:-1)*Math.abs(Math.round(h)-h||1)/2,s.prop("order",i),this.sortTracks(),this.saveConfig()},updateURL:function(){this.urlParamTemplate&&(this.useHash?window.location.hash=this.getQueryString():window.history.pushState({},"",this.getQueryString()))},popState:function(){var e=this.getURLCoords(),t=parseInt(e.start,10),i=parseInt(e.end,10);!e.start||t===this.start&&i===this.end||this.moveTo(t,i),this.closeMenus(),this.hideMessages()},getURLCoords:function(){var e=((this.useHash&&window.location.hash.replace(/^#/,"?")||window.location.search)+"&").match(this.paramRegex),t={},i=0;return e?(e=e.slice(2,-1),$.each(this.urlParamTemplate.split("__"),function(){var s=this.match(/^(CHR|START|END)$/);s&&(t[s[1].toLowerCase()]="CHR"===s[1]?e[i++]:parseInt(e[i++],10))}),t):t},getQueryString:function(){var e=this.urlParamTemplate.replace("__CHR__",this.chr).replace("__START__",this.start).replace("__END__",this.end);return this.useHash?e:window.location.search?(window.location.search+"&").replace(this.paramRegex,"$1"+e+"$5").slice(0,-1):"?"+e},supported:function(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))},die:function(e,t){t&&t.length?t.html(e):alert(e),this.failed=!0},menuTemplate:$('<div class="gv-menu"><div class="gv-close gv-menu-button">&#215;</div><div class="gv-menu-content"><div class="gv-title"></div><a class="gv-focus" href="#">Focus here</a><table></table></div></div>').on("click",function(e){$(e.target).hasClass("gv-close")&&$(this).fadeOut("fast",function(){var e=$(this).data();e.track&&e.track.prop("menus",e.track.prop("menus").not(this)),e.browser.menus=e.browser.menus.not(this)})}),makeMenu:function(e,t,i){if(!e.menuEl){var s,r,a,o,n,h,l,c,d,g=this,u=this.menuTemplate.clone(!0).data("browser",this),p=$(".gv-menu-content",u).remove();function f(){var e=$(this).data(),t=e.end-e.start+1,i=Math.max(Math.round(t/4),25);return g.moveTo(e.start-i,e.end+i,!0),!1}$.when(i?i.controller.populateMenu(e):e).done(function(t){for("[object Array]"!==Object.prototype.toString.call(t)&&(t=[t]),s=0;s<t.length;s++){for(h in r="",a=p.clone().appendTo(u),o=parseInt(void 0!==t[s].start?t[s].start:e.start,10),n=parseInt(void 0!==t[s].end?t[s].end:e.end,10),$(".gv-title",a)[t[s].title?"html":"remove"](t[s].title),i&&o&&n&&!g.isStatic?$(".gv-focus",a).data({start:o,end:Math.max(n,o)}).on("click",f):$(".gv-focus",a).remove(),t[s])/^start|end$/.test(h)&&!1===t[s][h]||"title"!==h&&(c=""===t[s][h]?' colspan="2"':"",r+="<tr><td"+c+">"+h+"</td>"+(c?"":"<td>"+t[s][h]+"</td></tr>"));$("table",a).html(r)}}),i&&u.addClass(i.id).data("track",i),e.menuEl=u.appendTo(this.superContainer||this.container),$(".gv-menu-content",u).each(function(){d=$("td:first",this).outerWidth(),$(".gv-title",this).width(function(e,t){return(l=Math.max(t,d))===t?($(this).addClass("gv-block"),"auto"):l})})}return this.menus=this.menus.add(e.menuEl),i&&i.prop("menus",i.prop("menus").add(e.menuEl)),e.menuEl.show(),t&&e.menuEl.css({left:0,top:0}).position({of:t,my:"left top",collision:"flipfit"}),e.menuEl},closeMenus:function(e){(e=e||this).menus.filter(":visible").children(".gv-close").trigger("click"),e.menus=$()},hideMessages:function(){this.autoHideMessages&&this.wrapper.find(".gv-message-container").addClass("gv-collapsed")},getSelectorPosition:function(){var e=this.selector.position().left,t=this.selector.outerWidth(!0),i=Math.round(e/this.scale)+this.start,s=Math.round((e+t)/this.scale)+this.start-1;return{start:i,end:s=s<=i?i:s,left:e,width:t}},on:function(e,t,i,s){var r,a,o,n,h,l=this,c={};function d(e,t){e=e.split(" ");for(var i=0;i<e.length;i++)c[e[i]]=(c[e[i]]||[]).concat(t)}function g(e){return e.toString()}function u(e){for(o=e.toString(),a=0;a<n.length;a++)if(o===n[a])return!0}if("object"==typeof e){for(r in e)d(r,e[r]);t=t||this}else void 0===i&&(i=t,t=this),d(e,i);var p=t instanceof Genoverse.Track||"tracks"===t?"tracks":"browser";for(r in c)h=r+(s?".once":""),l.events[p][h]=l.events[p][h]||[],n=$.map(c[r],g),$.grep(l.events[p][h],u).length||l.events[p][h].push.apply(l.events[p][h],c[r])},once:function(e,t,i){this.on(e,t,i,!0)},destroy:function(){for(var e in this.onTracks("destructor"),(this.superContainer||this.container).empty(),$(window).add(document).off(this.eventNamespace),this)delete this[e]}},{Plugins:{},wrapFunctions:function(e){for(var t in e)"function"!=typeof e[t]||"function"==typeof e[t].ancestor||t.match(/^(base|extend|constructor|on|once|prop|loadPlugins|loadGenome)$/)||Genoverse.functionWrap(t,e)},functionWrap:function(e,t){if(t.functions=t.functions||{},!t.functions[e]&&!e.match(/^(before|after)/)){var i=e.substring(0,1).toUpperCase()+e.substring(1),s=t instanceof Genoverse,r=s||t instanceof Genoverse.Track?t:t.track,a=s?t.events.browser:t.browser.events.tracks,o=(s?"Genoverse":t.id||t.name||"Track")+"."+e;t.functions[e]=t[e],t[e]=function(){var s,n=[].slice.call(arguments);function h(e){var t=a[e+i+".once"]||[],s=(a[e+i]||[]).concat(t,"function"==typeof r[e+i]?r[e+i]:[]);t.length&&delete a[e+i+".once"];for(var o=0;o<s.length;o++)s[o].apply(this,n)}return!0===t.debug?console.log(o):"object"==typeof t.debug&&t.debug[e]&&console.time("time: "+o),h.call(this,"before"),s=this.functions[e].apply(this,n),h.call(this,"after"),"object"==typeof t.debug&&t.debug[e]&&console.timeEnd("time: "+o),s}}}});Genoverse.id=0,Genoverse.prototype.origin=($("script[src]:last").attr("src").match(/(.*)js\/\w+/)||[])[1],$(function(){$('link[href="'+Genoverse.prototype.origin+'css/genoverse.css"]').length||$('<link href="'+Genoverse.prototype.origin+'css/genoverse.css" rel="stylesheet">').appendTo("body")}),window.Genoverse=Genoverse,Genoverse.Track=Base.extend({height:12,margin:2,resizable:!0,border:!0,unsortable:!1,name:void 0,autoHeight:void 0,hideEmpty:void 0,constructor:function(e){(this.stranded||e.stranded)&&(this.controller=this.controller||Genoverse.Track.Controller.Stranded,this.model=this.model||Genoverse.Track.Model.Stranded),this.setInterface(),this.extend(e),this.setDefaults(),this.setEvents(),Genoverse.wrapFunctions(this),this.setLengthMap(),this.setMVC()},setEvents:$.noop,setDefaults:function(){this.order=void 0!==this.order?this.order:this.index,this.defaultHeight=this.height,this.defaultAutoHeight=this.autoHeight,this.autoHeight=void 0!==this.autoHeight?this.autoHeight:this.browser.trackAutoHeight,this.hideEmpty=void 0!==this.hideEmpty?this.hideEmpty:this.browser.hideEmptyTracks,this.height+=this.margin,this.initialHeight=this.height,"auto"===this.resizable&&(this.autoHeight=!0)},setInterface:function(){var e,t=["Controller","Model","View","controller","model","view"];this._interface={};for(var i=0;i<3;i++)for(e in Genoverse.Track[t[i]].prototype)/^(constructor|init)$/.test(e)||(this._interface[e]=t[i+3])},setMVC:function(){this.model&&"function"==typeof this.model.abort&&this.model.abort();var e,t,i=this.getSettingsForLength(),s=$.extend(!0,{},this.constructor.prototype,i[1]),r=["model","view","controller"],a={},o={};s.controller=s.controller||this.controller||Genoverse.Track.Controller,s.model=this.models[i[0]]||s.model||this.model||Genoverse.Track.Model,s.view=this.views[i[0]]||s.view||this.view||Genoverse.Track.View;for(var n=0;n<3;n++)a[r[n]]={prop:{},func:{}};for(n in s)!/^(constructor|init|reset|setDefaults|base|extend|lengthMap)$/.test(n)&&isNaN(n)&&(this._interface[n]?a[this._interface[n]]["function"==typeof s[n]?"func":"prop"][n]=s[n]:Genoverse.Track.prototype.hasOwnProperty(n)||/^(controller|model|view)$/.test(n)||(o[n]=s[n]));for(this.extend(o),n=0;n<3;n++)if("controller"!==(e=r[n]))if("function"!=typeof s[e]||this[e]&&this[e].constructor.ancestor===s[e]){var h="object"==typeof s[e]&&this[e]!==s[e]?this[e]=s[e]:!!(this[e+"s"][i[0]]&&this.lengthMap.length>1)&&this[e+"s"][i[0]];if(h){for(t in a[e].prop)void 0!==h[t]&&(this[e][t]=a[e].prop[t]);this[e].constructor.extend(a[e].func),"model"===e&&void 0!==h.url&&this.model.setURL()}}else this[e]=this.newMVC(s[e],a[e].func,a[e].prop);this.controller&&"function"!=typeof this.controller?$.extend(this.controller,{model:this.model,view:this.view,threshold:a.controller.prop.threshold||this.controller.constructor.prototype.threshold}):this.controller=this.newMVC(s.controller,a.controller.func,$.extend(a.controller.prop,{model:this.model,view:this.view})),-1===this.strand&&this.orderReverse&&(this.order=this.orderReverse),i[1]&&(this.models[i[0]]=this.model,this.views[i[0]]=this.view)},newMVC:function(e,t,i){return new(e.extend($.extend(!0,{},e.prototype,t,{prop:$.proxy(this.prop,this)})))($.extend(i,{browser:this.browser,width:this.width,index:this.index,track:this}))},setLengthMap:function(){var e,t,i;for(var s in this.lengthMap=[],this.models={},this.views={},this)isNaN(s)||(e=this[s=parseInt(s,10)],delete this[s],this.lengthMap.push([s,!1===e?{threshold:s,resizable:"auto",featureHeight:0,model:Genoverse.Track.Model,view:Genoverse.Track.View}:e]));this.lengthMap.length&&(this.lengthMap.push([-1,$.extend(!0,{},this,{view:this.view||Genoverse.Track.View,model:this.model||Genoverse.Track.Model})]),this.lengthMap=this.lengthMap.sort(function(e,t){return t[0]-e[0]}));for(var r=0;r<this.lengthMap.length;r++)if(!this.lengthMap[r][1].model||!this.lengthMap[r][1].view){if(i={},-1!==this.lengthMap[r][0])for(t in this.lengthMap[r][1])this._interface[t]&&(i[this._interface[t]]=!0);for(t=r+1;t<this.lengthMap.length&&(!this.lengthMap[r][1].model&&this.lengthMap[t][1].model&&(this.lengthMap[r][1].model=i.model?Genoverse.Track.Model.extend($.extend(!0,{},this.lengthMap[t][1].model.prototype)):this.lengthMap[t][1].model),!this.lengthMap[r][1].view&&this.lengthMap[t][1].view&&(this.lengthMap[r][1].view=i.view?Genoverse.Track.View.extend($.extend(!0,{},this.lengthMap[t][1].view.prototype)):this.lengthMap[t][1].view),!this.lengthMap[r][1].model||!this.lengthMap[r][1].view);t++);}},getSettingsForLength:function(){for(var e=0;e<this.lengthMap.length;e++)if(this.browser.length>this.lengthMap[e][0]||1===this.browser.length&&1===this.lengthMap[e][0])return this.lengthMap[e];return[]},prop:function(e,t){var i,s=["controller","model","view"];if(this._interface[e])i=this[this._interface[e]];else{for(var r=0;r<3;r++)if(this[s[r]]&&void 0!==this[s[r]][e]){i=this[s[r]];break}i=i||this}return void 0!==t&&(null===t?delete i[e]:i[e]=t),i?i[e]:void 0},setHeight:function(e,t){return e=this.disabled||!0!==t&&e<this.prop("featureHeight")||this.prop("threshold")&&!this.prop("thresholdMessage")&&this.browser.length>this.prop("threshold")?0:Math.max(e,this.prop("minLabelHeight")),this.height=e,e},resetHeight:function(){if(!0===this.resizable){var e=this.prop("resizer");this.autoHeight=!![this.defaultAutoHeight,this.browser.trackAutoHeight].sort(function(e,t){return(void 0!==e&&null!==e?0:1)-(void 0!==t&&null!==t?0:1)})[0],this.controller.resize(this.autoHeight?this.prop("fullVisibleHeight"):this.defaultHeight+this.margin+(e?e.height():0)),this.initialHeight=this.height}},enable:function(){!0===this.disabled&&(this.disabled=!1,this.controller.resize(this.initialHeight),this.reset())},disable:function(){this.disabled||(this.disabled=!0,this.controller.resize(0))},reset:function(){!1!==this.prop("url")&&this.model.init(!0),this.view.init(),this.setLengthMap(),this.controller.reset()},remove:function(){this.browser.removeTrack(this)},destructor:function(){this.controller.destroy();var e=[this.view,this.model,this.controller,this];for(var t in e)for(var i in t)delete t[i]}}),Genoverse.Track.Controller=Base.extend({scrollBuffer:1.2,threshold:1/0,messages:void 0,constructor:function(e){$.extend(this,e),Genoverse.wrapFunctions(this),this.init()},init:function(){this.setDefaults(),this.addDomElements(),this.addUserEventHandlers()},setDefaults:function(){this.imgRange={},this.scrollRange={},this.messages=this.messages||{error:"ERROR: ",threshold:"Data for this track is not displayed in regions greater than ",resize:'Some features are currently hidden, <a class="gv-resize">resize to see all</a>'}},reset:function(){this.setDefaults(),this.resetImages(),this.browser.closeMenus(this),this.setScale(),this.makeFirstImage()},resetImages:function(){this.scrollContainer.empty(),this.resetImageRanges()},resetImageRanges:function(){this.left=0,this.scrollStart="ss-"+this.browser.start+"-"+this.browser.end,this.imgRange[this.scrollStart]=this.imgRange[this.scrollStart]||{left:-2*this.width,right:2*this.width},this.scrollRange[this.scrollStart]=this.scrollRange[this.scrollStart]||{start:this.browser.start-this.browser.length,end:this.browser.end+this.browser.length}},setName:function(e){this.track.name=e,this.labelName=this.labelName||$('<span class="gv-name">').appendTo(this.label),this.labelName.attr("title",e).html(e),this.minLabelHeight=Math.max(this.labelName.outerHeight(!0),this.labelName.outerHeight()),this.minLabelHeight&&this.label.height(this.prop("disabled")?0:Math.max(this.prop("height"),this.minLabelHeight))},addDomElements:function(){var e=this.track.name||"";this.menus=$(),this.container=$('<div class="gv-track-container">').appendTo(this.browser.wrapper),this.scrollContainer=$('<div class="gv-scroll-container">').appendTo(this.container),this.imgContainer=$('<div class="gv-image-container">').width(this.width),this.messageContainer=$('<div class="gv-message-container"><div class="gv-messages"></div><span class="gv-control gv-collapse">&laquo;</span><span class="gv-control gv-expand">&raquo;</span></div>').appendTo(this.container),this.label=$("<li>").appendTo(this.browser.labelContainer).height(this.prop("height")).data("track",this.track),this.context=$("<canvas>")[0].getContext("2d"),this.prop("border")&&$('<div class="gv-track-border">').appendTo(this.container),this.prop("unsortable")?this.label.addClass("gv-unsortable"):$('<div class="gv-handle">').appendTo(this.label),this.setName(e),this.container.height(this.prop("disabled")?0:Math.max(this.prop("height"),this.minLabelHeight))},addUserEventHandlers:function(){var e=this,t=this.browser;this.container.on("mouseup",".gv-image-container",function(i){i.which&&1!==i.which||"number"==typeof t.dragStart&&t.start!==t.dragStart||"select"===t.dragAction&&t.selector.outerWidth(!0)>2||e.click(i)}),this.messageContainer.children().on("click",function(){var t=e.messageContainer.children(".gv-messages").is(":visible")?" gv-collapsed":"",i=e.messageContainer.find(".gv-msg")[0].className.replace("gv-msg","").replace(" ","");e.messageContainer.attr("class","gv-message-container"+t),e.checkHeight(),"error"!==i&&(document.cookie=["gv_msg",i,e.prop("id")].join("_")+"=1; expires="+(t?"Tue, 19 Jan 2038":"Thu, 01 Jan 1970")+" 00:00:00 GMT; path=/")})},click:function(e){var t=$(e.target),i=e.pageX-this.container.parent().offset().left+this.browser.scaledStart,s=e.pageY-t.offset().top;this.imgContainer.hasClass("gv-flip")&&(s=t.height()-s);var r=this["gv-labels"===e.target.className?"labelPositions":"featurePositions"].search({x:i,y:s,w:1,h:1}).sort(function(e,t){return e.sort-t.sort})[0];r&&this.browser.makeMenu(r,e,this.track)},showMessage:function(e,t){var i=this.messageContainer.children(".gv-messages");if(!i.children(".gv-"+e).show().length){var s=$('<div class="gv-msg gv-'+e+'">'+this.messages[e]+(t||"")+"</div>").prependTo(i);"resize"===e&&s.children("a.gv-resize").on("click",$.proxy(function(){this.resize(this.fullVisibleHeight)},this)),this.messageContainer[document.cookie.match(["gv_msg",e,this.prop("id")].join("_")+"=1")?"addClass":"removeClass"]("gv-collapsed")}var r=this.messageContainer.show().outerHeight(!0);r>this.prop("height")&&this.resize(r),i=null},hideMessage:function(e){var t=this.messageContainer.find(".gv-msg");e?(t=t.filter(".gv-"+e).hide()).length&&!t.siblings().filter(function(){return"none"!==this.style.display}).length&&this.messageContainer.hide():(t.hide(),this.messageContainer.hide()),t=null},showError:function(e){this.showMessage("error",e)},checkHeight:function(){if(this.browser.length>this.threshold?this.thresholdMessage?(this.showMessage("threshold",this.thresholdMessage),this.fullVisibleHeight=Math.max(this.messageContainer.outerHeight(!0),this.minLabelHeight)):this.fullVisibleHeight=0:this.thresholdMessage&&this.hideMessage("threshold"),this.prop("resizable")){var e;if(this.browser.length>this.threshold)e=this.prop("autoHeight"),this.prop("autoHeight",!0);else{var t={x:this.browser.scaledStart,w:this.width,y:0,h:9e99},i=this.scale,s=this.featurePositions.search(t),r=this.prop("hideEmpty")?0:this.minLabelHeight,a=Math.max.apply(Math,$.map(s,function(e){return e.position[i].bottom}).concat(r));"separate"===this.prop("labels")&&(this.labelTop=a,a+=Math.max.apply(Math,$.map(this.labelPositions.search(t).concat(this.prop("repeatLabels")?s:[]),function(e){return e.position[i].label.bottom}).concat(r))),this.fullVisibleHeight=a||(this.messageContainer.is(":visible")?this.messageContainer.outerHeight(!0):r)}this.autoResize(),void 0!==e&&this.prop("autoHeight",e)}},autoResize:function(){var e=this.prop("autoHeight");e||"separate"===this.prop("labels")?this.resize(e?this.fullVisibleHeight:this.prop("height"),this.labelTop,!1):this.toggleExpander()},resize:function(e,t,i){e=this.track.setHeight(e,t),"number"==typeof t&&this.imgContainers.children(".gv-labels").css("top",t),this.container.add(this.label).height(e)[e?"show":"hide"](),this.toggleExpander(),!1!==i&&this.browser.saveConfig()},toggleExpander:function(){if(!0===this.prop("resizable")){var e=this.prop("featureMargin"),t=this.prop("height");if(this.fullVisibleHeight-e.top-e.bottom>t&&!this.prop("disabled")){this.showMessage("resize");var i=this,s=this.messageContainer.outerHeight(!0);s>t&&this.resize(s),this.expander=(this.expander||$('<div class="gv-expander gv-static">').width(this.width).appendTo(this.container).on("click",function(){i.resize(i.fullVisibleHeight)}))[0===this.prop("height")?"hide":"show"]()}else this.expander&&(this.hideMessage("resize"),this.expander.hide())}},setWidth:function(e){var t=this.track;$.each([this,t,t.model,t.view],function(){this.width=e}),this.imgContainer.add(this.expander).width(e)},setScale:function(){var e=this;this.scale=this.browser.scale,this.track.setMVC(),this.resetImageRanges();var t=this.prop("labels");t&&"overlay"!==t&&this.model.setLabelBuffer(this.browser.labelBuffer),this.threshold!==1/0&&"auto"!==this.prop("resizable")&&(this.thresholdMessage=this.view.formatLabel(this.threshold)),$.each(this.view.setScaleSettings(this.scale),function(t,i){e[t]=i}),this.hideMessage()},move:function(e){this.left+=e,this.scrollContainer.css("left",this.left);var t=this.scrollStart;if(this.imgRange[t].left+this.left>-this.scrollBuffer*this.width){var i=this.scrollRange[t].start-1;this.makeImage({scale:this.scale,start:i-this.browser.length+1,end:i,left:this.imgRange[t].left,cls:t}),this.imgRange[t].left-=this.width,this.scrollRange[t].start-=this.browser.length}if(this.imgRange[t].right+this.left<this.scrollBuffer*this.width){var s=this.scrollRange[t].end+1;this.makeImage({scale:this.scale,start:s,end:s+this.browser.length-1,left:this.imgRange[t].right,cls:t}),this.imgRange[t].right+=this.width,this.scrollRange[t].end+=this.browser.length}},moveTo:function(e,t,i){var s=this.scrollRange[this.scrollStart],r="ss-"+e+"-"+t;this.scrollRange[r]||e>s.end||t<s.start?(this.resetImageRanges(),this.makeFirstImage(r)):(this.move("number"==typeof i?i:(e-this.browser.start)*this.scale),this.checkHeight())},makeImage:function(e){var t;e.scaledStart=e.scaledStart||e.start*e.scale,e.width=e.width||this.width,e.height=e.height||this.prop("height"),e.featureHeight=e.featureHeight||0,e.labelHeight=e.labelHeight||0;var i=this,s=this.browser.length>this.threshold,r=this.imgContainer.clone().addClass((e.cls+" gv-loading").replace(".","_")).css({left:e.left,display:e.cls===this.scrollStart?"block":"none"}),a=!!e.background&&$('<img class="gv-bg">').hide().addClass(e.background).data(e).prependTo(r),o=$('<img class="gv-data">').hide().data(e).appendTo(r).on("load",function(){$(this).fadeIn("fast").parent().removeClass("gv-loading"),$(this).siblings(".gv-bg").show()});if(e.container=r,this.imgContainers.push(r[0]),this.scrollContainer.append(this.imgContainers),!s&&!this.model.checkDataRange(e.start,e.end)){var n=this.prop("dataBuffer");e.start-=n.start,e.end+=n.end,t=this.model.getData(e.start,e.end)}return t||(t=$.Deferred(),setTimeout($.proxy(t.resolve,this),1)),t.done(function(){var t=s?[]:i.model.findFeatures(e.start,e.end);i.render(t,o),a&&i.renderBackground(t,a)}).fail(function(e){i.showError(e)})},makeFirstImage:function(e){if(this.scrollContainer.children().hide().filter("."+(e||this.scrollStart)).show().length)return this.scrollContainer.css("left",0),this.checkHeight();var t=this,i=this.browser.start,s=this.browser.end,r=this.browser.length,a=this.scale,o=this.scrollStart,n=[{start:i,end:s,scale:a,cls:o,left:0}],h=0,l=this.width;this.browser.isStatic||(i>1&&(n.push({start:i-r,end:i-1,scale:a,cls:o,left:-this.width}),h=-this.width,l+=this.width),s<this.browser.chromosomeSize&&(n.push({start:s+1,end:s+r,scale:a,cls:o,left:this.width}),l+=this.width));var c=this.imgContainer.clone().addClass("gv-loading").css({left:h,width:l}).prependTo(this.scrollContainer.css("left",0));function d(){for(var e=0;e<n.length;e++)t.makeImage(n[e]);c.remove()}if(r>this.threshold||this.model.checkDataRange(i,s))d();else{var g=this.prop("dataBuffer");this.model.getData(i-g.start-r,s+g.end+r).done(d).fail(function(e){t.showError(e)})}},render:function(e,t){var i=t.data();e=this.view.positionFeatures(this.view.scaleFeatures(e,i.scale),i);var s=$("<canvas>").attr({width:i.width,height:i.featureHeight||1}),r="separate"===this.prop("labels")&&i.labelHeight?s.clone().attr("height",i.labelHeight):s,a=s[0].getContext("2d"),o=r[0].getContext("2d");switch(a.font=o.font=this.prop("font"),this.prop("labels")){case!1:break;case"overlay":o.textAlign="center",o.textBaseline="middle";break;default:o.textAlign="left",o.textBaseline="top"}this.view.draw(e,a,o,i.scale),t.attr("src",s[0].toDataURL()),o!==a&&t.clone(!0).attr({class:"gv-labels",src:r[0].toDataURL()}).insertAfter(t),this.checkHeight(),s=r=t=null},renderBackground:function(e,t,i){var s=$("<canvas>").attr({width:this.width,height:i||1})[0];this.view.drawBackground(e,s.getContext("2d"),t.data()),t.attr("src",s.toDataURL()),s=t=null},populateMenu:function(e){var t=$.extend(!0,{},e),i={title:t.label?t.label[0]:t.id,Location:this.browser.chr+":"+t.start+"-"+t.end};for(var s in delete t.start,delete t.end,delete t.sort,t)"object"!=typeof t[s]&&i.title!==t[s]||delete t[s];return $.extend(i,t)},destroy:function(){this.container.add(this.label).add(this.menus).remove()}}),Genoverse.Track.Model=Base.extend({dataType:"json",allData:!1,dataBuffer:void 0,xhrFields:void 0,url:void 0,urlParams:void 0,constructor:function(e){$.extend(this,e),Genoverse.wrapFunctions(this),this.init()},init:function(e){if(this.setDefaults(e),e)for(var t in this.featuresById)delete this.featuresById[t].position;else this.dataRanges=new RTree,this.features=new RTree,this.featuresById={};this.dataLoading=[]},setDefaults:function(e){this.dataBuffer=this.dataBuffer||{start:0,end:0},this.urlParams=this.urlParams||{},this.xhrFields=this.xhrFields||{},this._url||(this._url=this.url),(this.url||this._url&&e)&&this.setURL(void 0,e)},setURL:function(e,t){e=e||this.urlParams,t&&this._url&&(this.url=this._url),this.url+=(-1===this.url.indexOf("?")?"?":"&")+decodeURIComponent($.param(e,!0)),this.url=this.url.replace(/[&?]$/,"")},parseURL:function(e,t,i){return this.allData&&(e=1,t=this.browser.chromosomeSize),(i||this.url).replace(/__CHR__/,this.browser.chr).replace(/__START__/,e).replace(/__END__/,t)},setLabelBuffer:function(e){this.dataBuffer.start=Math.max(this.dataBuffer.start,e)},getData:function(e,t,i){e=Math.max(1,e),t=Math.min(this.browser.chromosomeSize,t);var s=this,r=$.Deferred(),a=[],o=t-e+1;if(!this.url)return r.resolveWith(this);if(this.dataRequestLimit&&o>this.dataRequestLimit)for(var n=Math.ceil(o/this.dataRequestLimit);n--;)a.push([e,n?e+=this.dataRequestLimit-1:t]),e++;else a.push([e,t]);return $.when.apply($,$.map(a,function(e){var t=$.ajax({url:s.parseURL(e[0],e[1]),dataType:s.dataType,context:s,xhrFields:s.xhrFields,success:function(t){this.receiveData(t,e[0],e[1])},error:function(e,t){this.track.controller.showError(t+" while getting the data, see console for more details",arguments)},complete:function(e){this.dataLoading=$.grep(this.dataLoading,function(t){return e!==t})}});return t.coords=[e[0],e[1]],"function"==typeof i&&t.done(i),s.dataLoading.push(t),t})).done(function(){r.resolveWith(s)}),r},receiveData:function(e,t,i){t=Math.max(t,1),i=Math.min(i,this.browser.chromosomeSize),this.setDataRange(t,i),this.parseData(e,t,i),this.allData&&(this.url=!1)},parseData:function(e,t,i){for(var s=0;s<e.length;s++){var r=e[s];r.sort=t+s,this.insertFeature(r)}},setDataRange:function(e,t){this.allData&&(e=1,t=this.browser.chromosomeSize),this.dataRanges.insert({x:e,w:t-e+1,y:0,h:1},[e,t])},checkDataRange:function(e,t){e=Math.max(1,e),t=Math.min(this.browser.chromosomeSize,t);var i=this.dataRanges.search({x:e,w:t-e+1,y:0,h:1}).sort(function(e,t){return e[0]-t[0]});if(!i.length)return!1;for(var s=1===i.length?i[0][0]:9e99,r=1===i.length?i[0][1]:-9e99,a=0;a<i.length-1;a++){if(!(i[a][0]<=i[a+1][0]&&(i[a][1]>=i[a+1][1]||i[a][1]+1>=i[a+1][0])))return!1;s=Math.min(s,i[a][0]),r=Math.max(r,i[a+1][1])}return e>=s&&t<=r},insertFeature:function(e){e.id||(e.id=e.ID||this.hashCode(JSON.stringify(e))),this.featuresById[e.id]||(this.features.insert({x:e.start,y:0,w:e.end-e.start+1,h:1},e),this.featuresById[e.id]=e)},findFeatures:function(e,t){return this.features.search({x:e-this.dataBuffer.start,y:0,w:t-e+this.dataBuffer.start+this.dataBuffer.end+1,h:1}).sort(function(e,t){return e.sort-t.sort})},abort:function(){for(var e=0;e<this.dataLoading.length;e++)this.dataLoading[e].abort();this.dataLoading=[]},hashCode:function(e){var t=0;if(!e.length)return t;for(var i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t&=t;return""+t}}),Genoverse.Track.View=Base.extend({fontHeight:10,fontFamily:"sans-serif",fontWeight:"normal",fontColor:"#000000",color:"#000000",minScaledWidth:.5,widthCorrection:1,labels:!0,repeatLabels:!1,bump:!1,depth:void 0,featureHeight:void 0,featureMargin:void 0,constructor:function(e){$.extend(this,e),Genoverse.wrapFunctions(this),this.init()},init:function(){this.setDefaults(),this.scaleSettings={}},setDefaults:function(){this.featureMargin=this.featureMargin||{top:3,right:1,bottom:1,left:0};for(var e=["Top","Right","Bottom","Left"],t=0;t<e.length;t++)"number"==typeof this["featureMargin"+e[t]]&&(this.featureMargin[e[t].toLowerCase()]=this["featureMargin"+e[t]]);this.context=$("<canvas>")[0].getContext("2d"),this.featureHeight=void 0!==this.featureHeight?this.featureHeight:this.prop("defaultHeight"),this.font=this.fontWeight+" "+this.fontHeight+"px "+this.fontFamily,this.labelUnits=["bp","kb","Mb","Gb","Tb"],this.labels&&"overlay"!==this.labels&&(this.depth||"labels"===this.bump)&&(this.labels="separate")},setScaleSettings:function(e){var t;return this.scaleSettings[e]||(t=t||new RTree,this.scaleSettings[e]={imgContainers:$(),featurePositions:t,labelPositions:"separate"===this.labels?new RTree:t}),this.scaleSettings[e]},scaleFeatures:function(e,t){for(var i,s=Math.max(t,this.widthCorrection),r=0;r<e.length;r++)(i=e[r]).position||(i.position={}),i.position[t]||(i.position[t]={start:i.start*t,width:Math.max((i.end-i.start)*t+s,this.minScaledWidth),height:i.height||this.featureHeight});return e},positionFeatures:function(e,t){t.margin=this.prop("margin");for(var i=0;i<e.length;i++)this.positionFeature(e[i],t);return t.width=Math.ceil(t.width),t.height=Math.ceil(t.height),t.featureHeight=Math.max(Math.ceil(t.featureHeight),this.prop("resizable")?Math.max(this.prop("height"),this.prop("minLabelHeight")):0),t.labelHeight=Math.ceil(t.labelHeight),e},positionFeature:function(e,t){var i=t.scale;if(e.position[i].X=e.position[i].start-t.scaledStart,!e.position[i].positioned){if(e.position[i].H=e.position[i].height+this.featureMargin.bottom,e.position[i].W=e.position[i].width+(e.marginRight||this.featureMargin.right),e.position[i].Y=("number"==typeof e.y?e.y*e.position[i].H:0)+this.featureMargin.top,e.label){"string"==typeof e.label&&(e.label=e.label.split("\n"));var s=this.context;e.labelHeight=e.labelHeight||(this.fontHeight+2)*e.label.length,e.labelWidth=e.labelWidth||Math.max.apply(Math,$.map(e.label,function(e){return Math.ceil(s.measureText(e).width)}))+1,!0===this.labels?(e.position[i].H+=e.labelHeight,e.position[i].W=Math.max(e.labelWidth,e.position[i].W)):"separate"!==this.labels||e.position[i].label||(e.position[i].label={x:e.position[i].start,y:e.position[i].Y,w:e.labelWidth,h:e.labelHeight})}var r={x:e.position[i].start,y:e.position[i].Y,w:e.position[i].W,h:e.position[i].H+this.featureMargin.top};if(!0===this.bump&&this.bumpFeature(r,e,i,this.scaleSettings[i].featurePositions),this.scaleSettings[i].featurePositions.insert(r,e),e.position[i].bottom=e.position[i].Y+e.position[i].H+t.margin,e.position[i].label){var a=$.extend(!0,{},e);this.bumpFeature(e.position[i].label,a,i,this.scaleSettings[i].labelPositions),a.position[i].label=e.position[i].label,a.position[i].label.bottom=a.position[i].label.y+a.position[i].label.h+t.margin,e=a,this.scaleSettings[i].labelPositions.insert(e.position[i].label,e),t.labelHeight=Math.max(t.labelHeight,e.position[i].label.bottom)}e.position[i].positioned=!0}t.featureHeight=Math.max(t.featureHeight,e.position[i].bottom),t.height=Math.max(t.height,t.featureHeight+t.labelHeight)},bumpFeature:function(e,t,i,s){var r,a=0;do{if(this.depth&&++a>=this.depth){$.grep(this.scaleSettings[i].featurePositions.search(e),function(e){return!1!==e.position[i].visible}).length&&(t.position[i].visible=!1);break}r=!1,(s.search(e)[0]||t).id!==t.id&&(e.y+=e.h,r=!0)}while(r);t.position[i].Y=e.y},draw:function(e,t,i,s){for(var r,a=0;a<e.length;a++)!1!==(r=e[a]).position[s].visible&&this.drawFeature($.extend({},r,{x:r.position[s].X,y:r.position[s].Y,width:r.position[s].width,height:r.position[s].height,labelPosition:r.position[s].label}),t,i,s)},drawFeature:function(e,t,i,s){(e.x<0||e.x+e.width>this.width)&&this.truncateForDrawing(e),!1!==e.color&&(e.color||this.setFeatureColor(e),t.fillStyle=e.color,t.fillRect(e.x,e.y,e.width,e.height)),this.labels&&e.label&&this.drawLabel(e,i,s),e.borderColor&&(t.strokeStyle=e.borderColor,t.strokeRect(e.x,e.y+.5,e.width,e.height)),e.decorations&&this.decorateFeature(e,t,s)},drawLabel:function(e,t,i){var s=e.untruncated,r=(s||e).width;if(!("overlay"===this.labels&&e.labelWidth>=Math.floor(r))){"string"==typeof e.label&&(e.label=[e.label]);var a,o,n,h,l,c=(s||e).x,d=this.repeatLabels?Math.ceil((r-Math.max(i,1)-("overlay"===this.labels?e.labelWidth:0))/this.width):1,g=r/d;this.repeatLabels&&i>1&&(g=this.browser.length*i,d=Math.ceil(r/g)),e.labelColor||this.setLabelColor(e),t.fillStyle=e.labelColor,"overlay"===this.labels?(a=[e.label.join(" ")],h=e.y+(e.height+1)/2,l=0):(a=e.label,h=e.labelPosition?e.labelPosition.y:e.y+e.height+this.featureMargin.bottom,l=this.fontHeight+2);var u="center"===t.textAlign?.5:0,p=e.labelWidth*u;for(d>1&&(u+=Math.max(Math.floor(-(e.labelWidth+c)/g),0));u<d;u++)if((o=c+u*g)+e.labelWidth>=0){if(o-p>this.width)break;for(n=0;n<a.length;n++)t.fillText(a[n],o,h+n*l)}}},setFeatureColor:function(e){e.color=this.color},setLabelColor:function(e){e.labelColor=e.color||this.fontColor||this.color},truncateForDrawing:function(e){var t=Math.min(Math.max(e.x,-1),this.width+1),i=e.x-t+e.width;i+t>this.width&&(i=this.width-t+1),e.untruncated={x:e.x,width:e.width},e.x=t,e.width=Math.max(i,0)},formatLabel:function(e){var t=Math.floor((e.toString().length-1)/3),i=this.labelUnits[t];return e/=Math.pow(10,3*t),Math.floor(e)+("bp"===i?"":"."+(e.toString().split(".")[1]||"").concat("00").substring(0,2))+" "+i},drawBackground:$.noop,decorateFeature:$.noop}),Genoverse.Track.Controller.Static=Genoverse.Track.Controller.extend({addDomElements:function(){this.base(),this.image=$("<img>").appendTo(this.imgContainer),this.container.toggleClass("gv-track-container gv-track-container-static").prepend(this.imgContainer),this.scrollContainer.add(this.messageContainer).remove()},reset:$.noop,setWidth:function(e){this.base(e),this.image.width=e},makeFirstImage:function(){this.base.apply(this,arguments),this.container.css("left",0),this.imgContainer.show()},makeImage:function(e){if(this.prop("disabled"))return $.Deferred().resolve();var t=this.view.positionFeatures(this.model.findFeatures(e.start,e.end),e);if(t){var i=JSON.stringify(t);if(this.stringified!==i){var s=this.prop("height");e.width=this.width,e.featureHeight=s,this.render(t,this.image.data(e)),this.imgContainer.children(":last").show(),this.resize(s,void 0,!1),this.stringified=i}}return $.Deferred().resolve()}}),Genoverse.Track.Model.Static=Genoverse.Track.Model.extend({url:!1,checkDataRange:function(){return!0}}),Genoverse.Track.View.Static=Genoverse.Track.View.extend({featureMargin:{top:0,right:1,bottom:0,left:1},positionFeature:$.noop,scaleFeatures:function(e){return e},draw:function(e,t,i,s){for(var r=0;r<e.length;r++)this.drawFeature(e[r],t,i,s)}}),Genoverse.Track.Static=Genoverse.Track.extend({controls:"off",resizable:!1,controller:Genoverse.Track.Controller.Static,model:Genoverse.Track.Model.Static,view:Genoverse.Track.View.Static}),Genoverse.Track.Controller.Stranded=Genoverse.Track.Controller.extend({constructor:function(e){if(this.base(e),"function"!=typeof this._makeImage){var t=this.prop("strand"),i=this.prop("featureStrand");-1===t?(this._makeImage=this.track.makeReverseImage?$.proxy(this.track.makeReverseImage,this):this.makeImage,this.makeImage=$.noop):(t=this.prop("strand",1),this._makeImage=this.makeImage,this.makeImage=this.makeForwardImage,this.reverseTrack=this.browser.addTrack(this.track.constructor.extend({strand:-1,url:!1,forwardTrack:this}),this.browser.tracks.length).controller),i||this.prop("featureStrand",t),this.model instanceof Genoverse.Track.Model.Stranded||this.track.lengthMap.push([-9e99,{model:Genoverse.Track.Model.Stranded}])}},makeForwardImage:function(e){var t=this.prop("reverseTrack"),i=this._makeImage(e);i&&"function"==typeof i.done?i.done(function(){t._makeImage(e,i)}):t._makeImage(e,i)},destroy:function(){this.removing||(this.removing=!0,this.browser.removeTrack((this.prop("forwardTrack")||this.prop("reverseTrack")).track),this.base())}}),Genoverse.Track.Model.Stranded=Genoverse.Track.Model.extend({init:function(e){if(this.base(e),!e){var t=this.prop("forwardTrack");t&&(this.features=t.prop("features"),this.featuresById=t.prop("featuresById"))}},setURL:function(e,t){this.base($.extend(e||this.urlParams,{strand:this.track.featureStrand}),t)},findFeatures:function(){var e=this.track.featureStrand;return $.grep(this.base.apply(this,arguments),function(t){return t.strand===e})}}),Genoverse.Track.Controller.Sequence=Genoverse.Track.Controller.extend({click:function(e){var t,i=e.pageX-this.container.parent().offset().left+this.browser.scaledStart,s=e.pageY-$(e.target).offset().top,r=this["gv-labels"===e.target.className?"labelPositions":"featurePositions"].search({x:i,y:s,w:1,h:1}).sort(function(e,t){return e.sort-t.sort});if(r.length){i=Math.floor(i/this.scale);for(var a=0;a<r.length;a++){if(r[a].alt_allele)return this.browser.makeMenu(r[a],e,this.track);if(t=r[a].sequence.charAt(i-r[a].start))return this.browser.makeMenu({title:t,Location:this.browser.chr+":"+i},e,this.track)}}}}),Genoverse.Track.Model.Sequence=Genoverse.Track.Model.extend({threshold:1e5,chunkSize:1e3,buffer:0,dataType:"text",init:function(){this.base(),this.chunks={}},getData:function(e,t){return e=e-e%this.chunkSize+1,t=t+this.chunkSize-t%this.chunkSize,this.base(e,t)},parseData:function(e,t,i){e=e.replace(/\n/g,""),this.prop("lowerCase")&&(e=e.toLowerCase());for(var s=0;s<e.length;s+=this.chunkSize)if(!this.chunks[t+s]){var r={id:t+s,start:t+s,end:t+s+this.chunkSize,sequence:e.substr(s,this.chunkSize),sort:t+s};this.chunks[r.start]=r,this.insertFeature(r)}}}),Genoverse.Track.Model.Sequence.Fasta=Genoverse.Track.Model.Sequence.extend({url:"http://genoverse.org/data/Homo_sapiens.GRCh37.72.dna.chromosome.1.fa",startByte:void 0,lineLength:void 0,getData:function(e,t){var i=$.Deferred();return $.when(this.getStartByte()).done(function(){e=e-e%this.chunkSize+1,t=t+this.chunkSize-t%this.chunkSize;var s=e-1+Math.floor((e-1)/this.lineLength)+this.startByte,r=t-1+Math.floor((t-1)/this.lineLength)+this.startByte;$.ajax({url:this.parseURL(e,t),dataType:this.dataType,context:this,headers:{Range:"bytes="+s+"-"+r},xhrFields:this.xhrFields,success:function(i){this.receiveData(i,e,t)},error:this.track.controller.showError}).done(function(){i.resolveWith(this)}).fail(function(){i.rejectWith(this)})}).fail(function(){i.rejectWith(this)}),i},getStartByte:function(){return this.startByteRequest?this.startByteRequest:void 0===this.startByte||void 0===this.lineLength?(this.startByteRequest=$.ajax({url:this.parseURL(),dataType:"text",context:this,headers:{Range:"bytes=0-300"},xhrFields:this.xhrFields,success:function(e){0===e.indexOf(">")?this.startByte=e.indexOf("\n")+1:this.startByte=0,this.lineLength=e.indexOf("\n",this.startByte)-this.startByte}}),this.startByteRequest):void 0}}),Genoverse.Track.View.Sequence=Genoverse.Track.View.extend({featureMargin:{top:0,right:0,bottom:0,left:0},colors:{default:"#CCCCCC",A:"#00986A",T:"#0772A1",G:"#FF8E00",C:"#FFDD73"},labelColors:{default:"#000000",A:"#FFFFFF",T:"#FFFFFF"},constructor:function(){this.base.apply(this,arguments);var e=this.prop("lowerCase");if(this.labelWidth={},this.widestLabel=e?"g":"G",this.labelYOffset=(this.featureHeight+(e?0:1))/2,e){for(var t in this.colors)this.colors[t.toLowerCase()]=this.colors[t];for(t in this.labelColors)this.colors[t.toLowerCase()]=this.colors[t]}},draw:function(e,t,i,s){t.textBaseline="middle",t.textAlign="left",this.labelWidth[this.widestLabel]||(this.labelWidth[this.widestLabel]=Math.ceil(this.context.measureText(this.widestLabel).width)+1);for(var r=Math.max(s,this.minScaledWidth),a=0;a<e.length;a++)this.drawSequence(e[a],t,s,r)},drawSequence:function(e,t,i,s){for(var r,a,o=this.labelWidth[this.widestLabel]<s-1,n=0;n<e.sequence.length;n++)(r=e.position[i].X+n*i)<-i||r>t.canvas.width||(a=e.sequence.charAt(n),t.fillStyle=this.colors[a]||this.colors.default,t.fillRect(r,e.position[i].Y,s,this.featureHeight),this.labelWidth[a]||(this.labelWidth[a]=Math.ceil(t.measureText(a).width)+1),o&&(t.fillStyle=this.labelColors[a]||this.labelColors.default,t.fillText(a,r+(s-this.labelWidth[a])/2,e.position[i].Y+this.labelYOffset)))}}),Genoverse.Track.View.SequenceVariation=Genoverse.Track.View.Sequence.extend({featureHeight:15,featureMargin:{top:0,right:0,bottom:4,left:0},bump:!0,showLegend:!1,positionFeature:function(e,t){var i=e.position[t.scale];e.alt_allele&&(i.positioned||(i.reference={end:i.start+e.ref_allele.length*t.scale}),i.reference.x=i.reference.end-t.scaledStart),this.base(e,t)},bumpFeature:function(e,t){t.alt_allele&&this.base.apply(this,arguments)},draw:function(e,t,i,s){for(var r={seq:[],snv:[]},a=0;a<e.length;a++)r[e[a].alt_allele?"snv":"seq"].push(e[a]);this.base(r.seq,t,i,s),this.highlightSNVs(r.snv,t,s),this.base(r.snv,t,i,s),this.outlineSNVs(r.snv,t,s)},highlightSNVs:function(e,t,i){for(var s,r,a,o=0;o<e.length;o++)(r=[(s=e[o].position[i]).X,s.reference.x,s.X+s.width])[2]<0||r[0]>this.width||((r[0]<0||r[2]>this.width)&&this.truncateForDrawing(r),a=[0,s.Y-this.featureMargin.bottom/2,s.Y,s.Y+this.featureHeight],e[o].highlightColor||this.setHighlightColor(e[o]),t.strokeStyle=t.fillStyle=e[o].highlightColor,t.lineWidth=2,t.beginPath(),t.moveTo(r[0],a[0]),t.lineTo(r[1],a[0]),t.lineTo(r[1],a[1]),t.lineTo(r[2],a[2]),t.lineTo(r[2],a[3]),t.lineTo(r[0],a[3]),t.closePath(),t.stroke(),t.lineWidth=1,t.globalAlpha=.5,t.fill(),t.globalAlpha=1)},outlineSNVs:function(e,t,i){for(var s,r,a,o=0;o<e.length;o++)r=[(s=e[o].position[i]).X,s.X+s.width],a=[s.Y,s.Y+this.featureHeight],t.strokeStyle=e[o].highlightColor,t.lineWidth=2,t.beginPath(),t.moveTo(r[1],a[0]),t.lineTo(r[1],a[1]),t.lineTo(r[0],a[1]),t.lineTo(r[0],a[0]),t.stroke(),t.lineWidth=1},truncateForDrawing:function(e){for(var t in e)e[t]=Math.min(Math.max(e[t],-1),this.width+1)},setHighlightColor:function(e){e.highlightColor="."===e.alt_allele||e.alt_allele.length<e.ref_allele.length?"#D31D00":"#1DD300"}}),Genoverse.Track.Model.SequenceVariation=Genoverse.Track.Model.extend({seqModel:Genoverse.Track.Model.Sequence.Ensembl,constructor:function(){this.base.apply(this,arguments),this.prop("models").seq=this.track.newMVC(this.seqModel)},getData:function(e,t){var i=$.Deferred(),s=this.prop("models").seq.checkDataRange(e,t);return this.base(e,t).done(function(){s?i.resolve():this.prop("models").seq.getData(e,t).done(i.resolve)}),i},checkDataRange:function(e,t){return this.base(e,t)&&this.prop("models").seq.checkDataRange(e,t)},findFeatures:function(e,t){return this.prop("models").seq.findFeatures(e,t).concat(this.base(e,t))}}),Genoverse.Track.Model.Gene.Ensembl=Genoverse.Track.Model.Gene.extend({url:"//rest.ensembl.org/overlap/region/human/__CHR__:__START__-__END__?feature=gene;content-type=application/json",dataRequestLimit:5e6,parseData:function(e){for(var t=0;t<e.length;t++){var i=e[t];"gene"!==i.feature_type||this.featuresById[i.id]||(i.label=i.external_name||i.id,i.transcripts=[],this.insertFeature(i))}}}),Genoverse.Track.View.Gene.Ensembl=Genoverse.Track.View.Gene.extend({setFeatureColor:function(e){var t="#000000";if(0===e.logic_name.indexOf("ensembl_havana"))t="#cd9b1d";else if(e.biotype.indexOf("RNA")>-1)t="#8b668b";else switch(e.biotype){case"protein_coding":t="#A00000";break;case"processed_transcript":case"antisense":case"sense_intronic":t="#0000FF";break;case"pseudogene":case"processed_pseudogene":t="#666666";break;default:t="#A00000"}e.color=e.labelColor=t}}),Genoverse.Track.Model.Transcript.Ensembl=Genoverse.Track.Model.Transcript.extend({url:"//rest.ensembl.org/overlap/region/human/__CHR__:__START__-__END__?feature=transcript;feature=exon;feature=cds;content-type=application/json",dataRequestLimit:5e6,parseData:function(e){for(var t=0;t<e.length;t++){var i=e[t];"transcript"!==i.feature_type||this.featuresById[i.id]?"exon"===i.feature_type&&this.featuresById[i.Parent]?this.featuresById[i.Parent].exons[i.id]||(this.featuresById[i.Parent].exons.push(i),this.featuresById[i.Parent].exons[i.id]=i):"cds"===i.feature_type&&this.featuresById[i.Parent]&&(i.id=i.start+"-"+i.end,this.featuresById[i.Parent].cds[i.id]||(this.featuresById[i.Parent].cds.push(i),this.featuresById[i.Parent].cds[i.id]=i)):(i.label=i.id,i.exons=[],i.cds=[],this.insertFeature(i))}}}),Genoverse.Track.View.Transcript=Genoverse.Track.View.extend({featureHeight:10,labels:!0,repeatLabels:!0,bump:!0,intronStyle:"bezierCurve",lineWidth:.5,drawFeature:function(e,t,i,s){this.setFeatureColor(e);var r,a,o,n=(e.exons||[]).sort(function(e,t){return e.start-t.start});for((!n.length||n[0].start>e.start)&&n.unshift({start:e.start,end:e.start}),(!n.length||n[n.length-1].end<e.end)&&n.push({start:e.end,end:e.end}),o=0;o<n.length;o++)r=n[o],t.strokeStyle=r.color||e.color||this.color,t.lineWidth=1,t.strokeRect(e.x+(r.start-e.start)*s,e.y+1.5,Math.max(1,(r.end-r.start)*s),e.height-3),o&&this.drawIntron({x:e.x+(n[o-1].end-e.start)*s,y:e.y+e.height/2+.5,width:(r.start-n[o-1].end)*s,height:e.strand>0?-e.height/2:e.height/2},t);if(e.cds&&e.cds.length)for(o=0;o<e.cds.length;o++)a=e.cds[o],t.fillStyle=a.color||e.color||this.color,t.fillRect(e.x+(a.start-e.start)*s,e.y,Math.max(1,(a.end-a.start)*s),e.height);this.labels&&e.label&&this.drawLabel(e,i,s)},drawIntron:function(e,t){switch(t.beginPath(),t.lineWidth=this.lineWidth,this.intronStyle){case"line":t.moveTo(e.x,e.y),t.lineTo(e.x+e.width,e.y);break;case"hat":t.moveTo(e.x,e.y),t.lineTo(e.x+e.width/2,e.y+e.height),t.lineTo(e.x+e.width,e.y);break;case"bezierCurve":t.moveTo(e.x,e.y),t.bezierCurveTo(e.x,e.y+e.height,e.x+e.width,e.y+e.height,e.x+e.width,e.y)}t.stroke(),t.closePath()}}),Genoverse.Track.View.Transcript.Ensembl=Genoverse.Track.View.Transcript.extend({setFeatureColor:function(e){Genoverse.Track.View.Gene.Ensembl.prototype.setFeatureColor(e)}}),Genoverse.Track.Model.File=Genoverse.Track.Model.extend({dataType:"text"}),Genoverse.Track.Model.File.BED=Genoverse.Track.Model.File.extend({parseData:function(e){for(var t=e.split("\n"),i=0;i<t.length;i++){var s=t[i].split("\t");if(!(s.length<3)&&(s[0]===this.browser.chr||s[0].toLowerCase()==="chr"+this.browser.chr||s[0].match("[^1-9]"+this.browser.chr+"$"))){var r=parseFloat(s[4],10),a="#000000";a=s[8]?"rgb("+s[8]+")":this.scoreColor(isNaN(r)?1e3:r),this.insertFeature({start:parseInt(s[1],10),end:parseInt(s[2],10),id:s[1]+"-"+s[3],label:s[3],color:a,originalFeature:s})}}},scoreColor:function(e){return e<=166?"rgb(219,219,219)":e<=277?"rgb(186,186,186)":e<=388?"rgb(154,154,154)":e<=499?"rgb(122,122,122)":e<=611?"rgb(94,94,94)":e<=722?"rgb(67,67,67)":e<=833?"rgb(42,42,42)":e<=944?"rgb(21,21,21)":"#000000"}}),Genoverse.Track.Model.File.GFF=Genoverse.Track.Model.File.extend({parseData:function(e){for(var t=e.split("\n"),i=0;i<t.length;i++)if(t[i].length&&0!==t[i].indexOf("#")){var s=t[i].split("\t");s.length<5||(s[0]===this.browser.chr||s[0].toLowerCase()==="chr"+this.browser.chr||s[0].match("[^1-9]"+this.browser.chr+"$"))&&this.insertFeature({id:s.slice(0,5).join("|"),start:parseInt(s[3],10),end:parseInt(s[4],10),source:s[1],type:s[2],score:s[5],strand:s[6]+"1",label:s[1]+" "+s[2]+" "+s[3]+"-"+s[4]})}}}),Genoverse.Track.Model.File.GTF=Genoverse.Track.Model.File.GFF,Genoverse.Track.Chromosome=Genoverse.Track.extend({id:"chromosome",margin:1,featureMargin:{top:0,right:0,bottom:0,left:0},labels:"overlay",url:!1,allData:!0,colors:{acen:"#708090",gneg:"#FFFFFF",gpos:"#000000",gpos100:"#000000",gpos25:"#D9D9D9",gpos33:"#BFBFBF",gpos50:"#999999",gpos66:"#7F7F7F",gpos75:"#666666",gvar:"#E0E0E0",stalk:"#708090"},labelColors:{gneg:"#000000",gvar:"#000000",gpos25:"#000000",gpos33:"#000000"},getData:function(e,t){return this.receiveData($.extend(!0,[],this.browser.genome[this.browser.chr].bands),e,t),$.Deferred().resolveWith(this)},insertFeature:function(e){e.label="acen"!==e.type&&"stalk"!==e.type&&e.id,e.menuTitle=e.id?this.browser.chr+e.id:this.browser.chr+":"+e.start+"-"+e.end,e.color=this.prop("colors")[e.type]||"#FFFFFF",e.labelColor=this.prop("labelColors")[e.type]||"#FFFFFF",this.base(e)},drawFeature:function(e,t,i,s){if(t.fillStyle=e.color,t.strokeStyle="#000000","acen"===e.type)t.beginPath(),this.drawnAcen?(t.moveTo(e.x+e.width,0),t.lineTo(e.x+e.width,e.height+.5),t.lineTo(e.x,e.height/2)):(t.moveTo(e.x,0),t.lineTo(e.x+e.width,e.height/2),t.lineTo(e.x,e.height+.5),this.drawnAcen=!0),t.closePath(),t.fill(),t.stroke();else if("stalk"===e.type)for(var r=0;r<2;r++)t.beginPath(),t.moveTo(e.x,0),t.lineTo(e.x+.25*e.width,.25*e.height+.5),t.lineTo(e.x+.75*e.width,.25*e.height+.5),t.lineTo(e.x+e.width,0),t[r?"moveTo":"lineTo"](e.x+e.width,e.height),t.lineTo(e.x+.75*e.width,.75*e.height-.5),t.lineTo(e.x+.25*e.width,.75*e.height-.5),t.lineTo(e.x,e.height),t[r?"stroke":"fill"]();else this.base(e,t,i,s),t.beginPath(),1===e.start&&e.end===this.browser.chromosomeSize?(t.clearRect(0,0,5,this.prop("height")),t.clearRect(e.width-5,0,10,this.prop("height")),t.fillStyle=e.color,t.moveTo(5,.5),t.lineTo(e.width-5,.5),t.bezierCurveTo(this.width+1,.5,this.width+1,e.height+.5,e.width-5,e.height+.5),t.lineTo(5,e.height+.5),t.bezierCurveTo(-1,e.height+.5,-1,.5,5,.5),t.fill()):1===e.start?(t.clearRect(0,0,5,this.prop("height")),t.fillStyle=e.color,t.moveTo(5,.5),t.lineTo(e.x+e.width,.5),t.moveTo(5,e.height+.5),t.lineTo(e.x+e.width,e.height+.5),t.moveTo(5,.5),t.bezierCurveTo(-1,.5,-1,e.height+.5,5,e.height+.5),t.fill()):e.end===this.browser.chromosomeSize?(t.clearRect(e.x+e.width-5,0,10,this.prop("height")),t.fillStyle=e.color,t.moveTo(e.x,.5),t.lineTo(e.x+e.width-5,.5),t.moveTo(e.x,e.height+.5),t.lineTo(e.x+e.width-5,e.height+.5),t.moveTo(e.x+e.width-5,.5),t.bezierCurveTo(this.width+1,.5,this.width+1,e.height+.5,e.x+e.width-5,e.height+.5),t.fill()):(t.moveTo(e.x,.5),t.lineTo(e.x+e.width,.5),t.moveTo(e.x,e.height+.5),t.lineTo(e.x+e.width,e.height+.5)),t.stroke()},drawLabel:function(e){(1===e.start||e.end===this.browser.chromosomeSize)&&e.labelWidth>=Math.floor(e.width-5)||this.base.apply(this,arguments)},populateMenu:function(e){return{title:e.menuTitle,Position:this.browser.chr+":"+e.start+"-"+e.end}}}),Genoverse.Track.File=Genoverse.Track.extend({setInterface:function(){this.base(),this._interface.data="model"}}),Genoverse.Track.File.BED=Genoverse.Track.File.extend({name:"BED",model:Genoverse.Track.Model.File.BED,bump:!0,featureHeight:6,populateMenu:function(e){return{title:'<a target=_blank href="https://genome.ucsc.edu/FAQ/FAQformat.html#format1">BED feature details</a>',chrom:e.originalFeature[0],chromStart:e.originalFeature[1],chromEnd:e.originalFeature[2],name:e.originalFeature[3],score:e.originalFeature[4],strand:e.originalFeature[5],thickStart:e.originalFeature[6],thickEnd:e.originalFeature[7],itemRgb:e.originalFeature[8],blockCount:e.originalFeature[9],blockSizes:e.originalFeature[10],blockStarts:e.originalFeature[11]}}}),Genoverse.Track.File.VCF=Genoverse.Track.File.extend({name:"VCF",model:Genoverse.Track.Model.SequenceVariation.VCF,autoHeight:!1,populateMenu:function(e){return{title:'<a target="_blank" href="http://www.1000genomes.org/node/101">VCF feature details</a>',CHROM:e.originalFeature[0],POS:e.originalFeature[1],ID:e.originalFeature[2],REF:e.originalFeature[3],ALT:e.originalFeature[4],QUAL:e.originalFeature[5],FILTER:e.originalFeature[6],INFO:e.originalFeature[7].split(";").join("<br />")}},1:{view:Genoverse.Track.View.Sequence.extend({bump:!0,labels:!1,featureMargin:{top:0,right:0,bottom:0,left:0},draw:function(e,t,i,s){this.base.apply(this,arguments),this.highlightRef(e,t,s)},highlightRef:function(e,t,i){t.strokeStyle="black";for(var s=0;s<e.length;s++)"REF"===e[s].allele&&t.strokeRect(e[s].position[i].X,e[s].position[i].Y,e[s].position[i].width,e[s].position[i].height)}})},1000:{view:Genoverse.Track.View.extend({bump:!1,labels:!1,drawFeature:function(e){if(!e.color){var t=e.originalFeature[5],i=Math.min(255,Math.floor(255*t/this.maxQUAL))-127,s=i>0?255:127+i,r=i<0?255:127-i;e.color="rgb("+s+","+r+",0)"}this.base.apply(this,arguments)}})}}),Genoverse.Track.Gene=Genoverse.Track.extend({id:"genes",name:"Genes",height:200,populateMenu:function(e){var t={title:'<a target="_blank" href="'+("http://grch37.ensembl.org/Homo_sapiens/"+("transcript"===e.feature_type?"Transcript":"Gene")+"/Summary?"+("transcript"===e.feature_type?"t":"g")+"="+e.id)+'">'+(e.external_name?e.external_name+" ("+e.id+")":e.id)+"</a>",Location:this.browser.chr+":"+e.start+"-"+e.end,Source:e.source,Biotype:e.biotype};return"transcript"===e.feature_type&&(t.Gene='<a target="_blank" href="http://grch37.ensembl.org/Homo_sapiens/Gene/Summary?g='+e.Parent+'">'+e.Parent+"</a>"),t},2000000:{labels:!1},100000:{labels:!0,model:Genoverse.Track.Model.Gene.Ensembl,view:Genoverse.Track.View.Gene.Ensembl},1:{labels:!0,model:Genoverse.Track.Model.Transcript.Ensembl,view:Genoverse.Track.View.Transcript.Ensembl}}),Genoverse.Track.HighlightRegion=Genoverse.Track.extend({unsortable:!0,repeatLabels:!0,resizable:!1,border:!1,height:15,featureHeight:2,order:-1,orderReverse:9e99,controls:"off",color:"#555",background:"#DDD",labels:"separate",featureMargin:{top:13,right:0,bottom:0,left:0},margin:0,controller:Genoverse.Track.Controller.Stranded.extend({setDefaults:function(){-1===this.prop("strand")&&(this.prop("labels",!1),this.prop("border",!1),this.prop("height",2),this.prop("featureMargin").top=0),this.base()},setName:function(e){-1===this.prop("strand")?(this.base(""),this.minLabelHeight=0,this.label.height(0)):this.base(e)},makeImage:function(e){1===this.prop("strand")&&(e.background="gv-full-height");var t=this.base(e);return e.container.addClass(e.background),t},render:function(e,t){this.base(e,t),t.siblings(".gv-labels").css("top",this.prop("featureHeight")-this.prop("featureMargin").top)},renderBackground:function(e,t){this.base(e,t),t.height(this.browser.wrapper.outerHeight(!0))},click:$.noop}),model:Genoverse.Track.Model.Stranded.extend({findFeatures:function(){return Genoverse.Track.Model.prototype.findFeatures.apply(this,arguments)}}),view:Genoverse.Track.View.extend({positionFeatures:function(e,t){if(-1===this.prop("strand")){for(var i=t.scale,s=$.extend(!0,[],e),r=s.length;r--;)delete s[r].position[i].H,delete s[r].position[i].Y,delete s[r].position[i].bottom,delete s[r].position[i].positioned;return this.base(s,t)}return this.base(e.reverse(),t)},draw:function(e,t,i,s){1===this.prop("strand")&&(t.fillStyle="#FFF",t.fillRect(0,0,t.canvas.width,t.canvas.height)),this.base(e,t,i,s)},drawBackground:function(e,t,i){for(var s=0;s<e.length;s++)this.drawFeature($.extend({},e[s],{x:e[s].position[i.scale].X,y:0,width:e[s].position[i.scale].width,height:t.canvas.height,color:this.prop("background"),label:!1,decorations:!0}),t,!1,i.scale)},decorateFeature:function(e,t,i){var s=e.x+.5,r=s+e.width;t.strokeStyle=this.color,t.lineWidth=2,s>=0&&s<=this.width&&(t.moveTo(s,e.y),t.lineTo(s,e.y+e.height)),r>=0&&r<=this.width&&(t.moveTo(r,e.y),t.lineTo(r,e.y+e.height)),t.stroke(),t.lineWidth=1}})}),Genoverse.Track.Legend=Genoverse.Track.Static.extend({textColor:"#000000",labels:"overlay",unsortable:!0,lockToTrack:!0,featureHeight:12,controller:Genoverse.Track.Controller.Static.extend({init:function(){this.base(),this.container.addClass("gv-track-container-legend"),this.browser.legends||(this.browser.legends={}),this.browser.legends[this.track.id]=this,this.track.setTracks()}}),setEvents:function(){this.browser.on({"afterInit afterAddTracks afterRemoveTracks":function(){for(var e in this.legends)this.legends[e].track.setTracks()},afterRemoveTracks:function(e){for(var t in e)e[t].controller.legend&&0===e[t].controller.legend.track.tracks.length&&e[t].controller.legend.track.remove();for(var t in this.legends)this.legends[t].makeImage({})},afterUpdateTrackOrder:function(){for(var e in this.legends)this.legends[e].track.updateOrder()}}),this.browser.on({afterPositionFeatures:function(e,t){var i=this.prop("legend");i&&setTimeout(function(){i.makeImage(t)},1)},afterResize:function(e,t){var i=this.prop("legend");i&&!0===t&&i.makeImage({})},afterCheckHeight:function(){var e=this.prop("legend");e&&e.makeImage({})}},this)},setTracks:function(){var e=this,t=this.featureType;this.tracks=$.grep(this.browser.tracks,function(i){if(i.type===t&&i.controller)return i.controller.legend=e.controller,!0}),this.updateOrder(),"object"==typeof this.controller&&this[this.tracks.length?"enable":"disable"]()},updateOrder:function(){this.tracks.length&&!this.browser._constructing&&(this.lockToTrack&&(this.order=this.tracks[this.tracks.length-1].order+.1),this.browser.sortTracks())},findFeatures:function(){var e={x:this.browser.scaledStart,y:0,w:this.width},t={};return $.each($.map(this.track.tracks,function(t){var i=t.prop("featurePositions");return e.h=t.prop("height"),i?i.search(e).concat(t.prop("labelPositions").search(e)):[]}),function(){this.legend&&(t[this.legend]=this.color)}),$.map(t,function(e,t){return[[t,e]]}).sort(function(e,t){var i=e[0].toLowerCase(),s=t[0].toLowerCase();return i<s?-1:i>s?1:0})},positionFeatures:function(e,t){if(t.positioned)return e;for(var i,s,r,a=0,o=0,n=this.width/2,h=this.fontHeight+5,l=[],c=0;c<e.length;c++)i=a*n+5,s=o*h+5,r=this.context.measureText(e[c][0]).width,l.push({x:i,y:s,width:20,height:this.featureHeight,color:e[c][1]},{x:i+5+20,y:s,width:r+1,height:this.featureHeight,color:!1,labelColor:this.textColor,labelWidth:r,label:e[c][0]}),2==++a&&(a=0,o++);return t.height=this.prop("height",e.length?(o+(a?1:0))*h+5:0),t.width=this.width,t.positioned=!0,this.base(l,t)},enable:function(){this.base(),this.controller.makeImage({})},disable:function(){delete this.controller.stringified,this.base()},destroy:function(){delete this.browser.legends[this.id],this.base()}}),Genoverse.Track.Scaleline=Genoverse.Track.Static.extend({strand:1,color:"#000000",height:12,labels:"overlay",unsortable:!0,resize:$.noop,makeFirstImage:function(){this.prop("scaleline",!1),this.base.apply(this,arguments)},render:function(e,t){this.base(e,t),this.prop("drawnScale",t.data("scale"))},positionFeatures:function(e,t){var i=this.prop("scaleline");if(t.scale===this.drawnScale)return!1;if(i)return i;var s,r,a=this.prop("strand"),o=this.prop("height"),n=this.formatLabel(this.browser.length),h=1===a?"Forward strand":"Reverse strand",l=this.context.measureText(n).width,c=this.context.measureText(h).width,d=this.prop("imgContainer").css("backgroundColor");return 1===a?(s=0,r=this.width-c-40):(s=25,r=30),i=[{x:s,y:o/2,width:this.width-25,height:1,decorations:!0},{x:(this.width-l-10)/2,y:0,width:l+10,height:o,color:d,labelColor:this.color,labelWidth:l,label:n},{x:r,y:0,width:c+10,height:o,color:d,labelColor:this.color,labelWidth:c,label:h}],this.base(this.prop("scaleline",i),t)},decorateFeature:function(e,t){var i=this.prop("strand"),s=this.prop("height"),r=1===i?this.width-25:25;t.strokeStyle=this.color,t.beginPath(),t.moveTo(r,.25*s),t.lineTo(r+20*i,.5*s),t.lineTo(r,.75*s),t.closePath(),t.stroke(),t.fill()}}),Genoverse.Track.Scalebar=Genoverse.Track.extend({unsortable:!0,order:0,orderReverse:1e5,featureStrand:1,controls:"off",height:20,featureHeight:3,featureMargin:{top:0,right:0,bottom:2,left:0},margin:0,minPixPerMajor:100,color:"#000000",autoHeight:!1,labels:!0,bump:!1,resizable:!1,click:$.noop,colors:{majorGuideLine:"#CCCCCC",minorGuideLine:"#E5E5E5"},setEvents:function(){var e=this.browser;function t(){$(".gv-bg.gv-full-height",e.container).height(function(){return e.wrapper.outerHeight(!0)-$(this).parents(".gv-track-container").position().top})}e.on("afterAddTracks",t),e.on("afterResize",this,t)},setScale:function(){var e,t,i=this.prop("width")/this.prop("minPixPerMajor"),s=5,r=-1,a=(""+this.browser.start).split(""),o=(""+this.browser.end).split("");for(t=a.length;t<o.length;t++)a.unshift("0");for(t=o.length;t<a.length;t++)o.unshift("0");for(t=0;t<a.length;t++)if((e=parseInt(o.slice(0,a.length-t).join(""),10)-parseInt(a.slice(0,a.length-t).join(""),10))&&e<=i){r=parseInt("1"+$.map(new Array(t),function(){return"0"}).join(""),10);break}-1===r?(r=1===this.browser.length?1:parseInt("1"+$.map(new Array(a.length),function(){return"0"}).join(""),10),s=1):5*e<=i?(r/=5,s=2):4*e<=i?(r/=4,s=1):2*e<=i&&(r/=2),r=Math.max(r,1),this.prop("minorUnit",Math.max(r/s,1)),this.prop("majorUnit",r),this.prop("features",new RTree),this.prop("featuresById",{}),this.prop("seen",{}),this.base()},setFeatures:function(e,t){for(var i,s,r,a=this.prop("minorUnit"),o=this.prop("majorUnit"),n=this.prop("seen"),h=(e=Math.max(e-e%a-o,0))/a%2?1:-1,l=e;l<t+a;l+=a)h*=-1,n[l]||(n[l]=1,i={id:l,strand:1,sort:l},s=l&&l%o==0,1===h&&(i.start=l,i.end=l+a-1),s&&((r=this.track.view.formatLabel(l))!==this.lastLabel&&(i.label=r,i.end||(i.start=l,i.end=l-1)),this.lastLabel=r),i.end&&this.insertFeature(i))},makeFirstImage:function(e){return-1===this.prop("strand")&&(e=this.track.forwardTrack.scrollStart),this.base(e)},makeImage:function(e){e.background="gv-guidelines gv-full-height",e.featureHeight=this.prop("height"),this.track.setFeatures.apply(this.track.model,[e.start,e.end]);var t=this.base(e);return e.container.addClass("gv-full-height"),t},makeReverseImage:function(e){this.imgContainers.push(e.container.clone().html(e.container.children(".gv-data").clone(!0).css("background",this.browser.wrapper.css("backgroundColor")))[0]),this.scrollContainer.append(this.imgContainers)},renderBackground:function(e,t){this.base(e,t),t.height(this.browser.wrapper.outerHeight(!0))},draw:function(e,t,i,s){var r,a,o=e.length,n=this.prop("minorUnit"),h=Math.ceil(n*s);for(t.textBaseline="top",t.fillStyle=this.color,this.guideLines={major:{}};o--;)r=e[o],a=Math.round(r.position[s].X),this.drawFeature($.extend({},r,{x:a,y:0,width:Math.ceil(r.position[s].width),height:this.featureHeight}),t,i,s),r.label&&(a>-1&&t.fillRect(a,this.featureHeight,1,this.featureHeight),this.guideLines.major[r.start]=!0),this.guideLines[r.start]=a,this.guideLines[r.start+n]=a+h-1;t.fillRect(0,0,t.canvas.width,1),t.fillRect(0,this.featureHeight,t.canvas.width,1)},drawBackground:function(e,t){for(var i in this.guideLines)this.guideLines[i]>=0&&this.guideLines[i]<=this.width&&(t.fillStyle=this.track.colors[this.guideLines.major[i]?"majorGuideLine":"minorGuideLine"],t.fillRect(this.guideLines[i],0,1,t.canvas.height))},formatLabel:function(e){return this.prop("minorUnit")<1e3?e.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"):this.base(e)}});
//# sourceMappingURL=genoverse.nodeps.min.js.map
